# @bolink-inventory-system/quality - 质量控制模块

## 模块概述
质量控制模块负责新能源电池从采购入库到销售出库全过程的质量管理，确保产品质量符合标准要求，建立完整的质量追溯体系。

## 核心功能

### 1. 质量检验管理

#### 1.1 入库质量检验
- **检验计划制定**：根据采购订单制定检验计划
- **抽样检验**：按照抽样标准进行产品抽样
- **外观检查**：检查产品外观、包装、标识
- **尺寸测量**：测量产品的关键尺寸参数
- **基础性能测试**：电压、容量等基础参数测试

#### 1.2 检验标准管理
- **国家标准**：GB/T相关电池标准
- **行业标准**：IEC、UL等国际标准
- **企业标准**：公司内部质量标准
- **客户标准**：特定客户的质量要求
- **检验作业指导书**：详细的检验操作规程

#### 1.3 检验设备管理
- **设备台账**：检验设备的基本信息
- **设备校准**：定期校准检验设备
- **设备维护**：设备的保养和维修
- **设备状态**：设备的使用状态管理
- **计量证书**：设备计量认证管理

#### 1.4 检验结果管理
- **检验记录**：详细记录检验过程和结果
- **合格判定**：根据标准判定产品合格性
- **检验报告**：生成检验报告和证书
- **数据统计**：检验数据的统计分析
- **趋势分析**：质量趋势的分析和预警

### 2. 批次追溯管理 - 增强功能

#### 2.1 批次信息建档
- **批次基本信息**：批次号、生产日期、生产厂家
- **原材料信息**：原材料批次、供应商信息
- **生产工艺信息**：生产工艺参数、生产设备
- **质量信息**：检验结果、质量等级
- **流转记录**：批次在各环节的流转记录

#### 2.2 上游追溯
- **原材料追溯**：追溯到原材料供应商
- **生产过程追溯**：追溯生产工艺和设备
- **质量记录追溯**：追溯质量检验记录
- **运输过程追溯**：追溯运输和存储条件
- **供应链追溯**：完整的供应链追溯

#### 2.3 下游追溯
- **销售记录追溯**：追溯销售订单和客户
- **应用场景追溯**：追溯产品应用场景
- **服务记录追溯**：追溯售后服务记录
- **最终用户追溯**：追溯到最终使用者
- **问题反馈追溯**：追溯质量问题反馈

#### 2.4 问题批次快速定位
- **问题批次识别**：快速识别有问题的批次
- **影响范围分析**：分析问题批次的影响范围
- **客户通知**：及时通知相关客户
- **库存隔离**：隔离问题批次库存
- **召回管理**：必要时启动产品召回

#### 2.5 批次追溯数据模型 - 新增
```sql
CREATE TABLE batch_traceability (
    id SERIAL PRIMARY KEY,
    batch_number VARCHAR(100) UNIQUE NOT NULL,    -- 批次号
    product_id INTEGER NOT NULL REFERENCES products(id),
    manufacturer VARCHAR(200),                    -- 生产厂商
    production_date DATE,                         -- 生产日期
    production_line VARCHAR(50),                  -- 生产线编号
    production_shift VARCHAR(20),                 -- 生产班次
    quality_grade VARCHAR(20),                    -- 质量等级
    raw_materials JSONB,                          -- 原材料信息
    production_process JSONB,                     -- 生产工艺
    quality_records JSONB,                        -- 质量记录
    flow_records JSONB,                           -- 流转记录
    upstream_batches JSONB,                       -- 上游批次
    downstream_records JSONB,                     -- 下游流向
    certifications JSONB,                         -- 认证信息
    expiry_date DATE,                             -- 到期日期
    shelf_life_days INTEGER,                      -- 保质期天数
    storage_requirements JSONB,                   -- 存储要求
    handling_instructions TEXT,                   -- 操作说明
    regulatory_info JSONB,                        -- 法规信息
    status VARCHAR(20) DEFAULT 'active',          -- 状态
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.6 追溯查询功能 - 新增
- **批次信息查询**：查询批次的基本信息
- **上游追溯查询**：查询批次的上游信息
- **下游追溯查询**：查询批次的下游流向
- **质量记录查询**：查询批次的质量记录
- **流转轨迹查询**：查询批次的流转轨迹

### 3. 不合格品处理

#### 3.1 不合格品识别
- **入库检验不合格**：入库时发现的不合格品
- **在库抽检不合格**：库存抽检发现的问题
- **客户反馈不合格**：客户反馈的质量问题
- **内部发现不合格**：内部检查发现的问题
- **第三方检测不合格**：第三方检测发现的问题

#### 3.2 不合格品隔离
- **物理隔离**：将不合格品物理隔离存放
- **系统标识**：在系统中标识不合格品状态
- **权限控制**：限制不合格品的操作权限
- **标识管理**：明确的不合格品标识
- **隔离区管理**：专门的不合格品隔离区域

#### 3.3 不合格品处置
- **返工处理**：对可返工的产品进行返工
- **降级使用**：将产品降级到合适的应用
- **退货处理**：退回供应商处理
- **报废处理**：对无法使用的产品报废
- **特采使用**：特殊情况下的特采审批

#### 3.4 原因分析与改进
- **原因分析**：深入分析不合格的根本原因
- **责任认定**：确定质量问题的责任方
- **改进措施**：制定针对性的改进措施
- **效果验证**：验证改进措施的有效性
- **预防措施**：制定预防类似问题的措施

### 4. 供应商质量评价

#### 4.1 质量绩效统计
- **合格率统计**：统计供应商的合格率
- **退货率统计**：统计供应商的退货率
- **投诉率统计**：统计供应商的投诉率
- **交付及时率**：统计供应商的交付及时率
- **服务响应率**：统计供应商的服务响应率

#### 4.2 质量评价体系
- **评价指标**：建立质量评价指标体系
- **评价周期**：定期进行质量评价
- **评价方法**：科学的评价方法
- **评价结果**：评价结果的应用
- **持续改进**：基于评价结果的改进

#### 4.3 供应商分级管理
- **A级供应商**：优秀供应商，优先合作
- **B级供应商**：良好供应商，正常合作
- **C级供应商**：一般供应商，限制合作
- **D级供应商**：不合格供应商，停止合作
- **供应商发展**：帮助供应商提升质量水平

## 数据模型设计

### 质量检验记录表 (quality_inspections)
```sql
- id: 主键
- inspection_code: 检验单号
- product_id: 产品ID
- batch_number: 批次号
- supplier_id: 供应商ID
- inspection_type: 检验类型
- inspection_date: 检验日期
- inspector: 检验员
- supervisor: 监检员
- sample_quantity: 抽样数量
- total_quantity: 总数量
- inspection_standard: 检验标准
- inspection_method: 检验方法
- inspection_equipment: 检验设备
- environment_conditions: 环境条件
- inspection_result: 检验结果
- defect_description: 缺陷描述
- defect_rate: 缺陷率
- conclusion: 检验结论
- corrective_actions: 纠正措施
- follow_up_required: 是否需要后续跟踪
- next_inspection_date: 下次检验日期
- certificate_number: 证书编号
- remarks: 备注
- created_at: 创建时间
- completed_at: 完成时间
```

### 批次追溯表 (batch_traceability) - 新增
```sql
- id: 主键
- batch_number: 批次号
- product_id: 产品ID
- manufacturer: 生产厂商
- production_date: 生产日期
- production_line: 生产线编号
- production_shift: 生产班次
- quality_grade: 质量等级
- raw_materials: 原材料信息(JSON)
- production_process: 生产工艺(JSON)
- quality_records: 质量记录(JSON)
- flow_records: 流转记录(JSON)
- upstream_batches: 上游批次(JSON)
- downstream_records: 下游流向(JSON)
- certifications: 认证信息(JSON)
- expiry_date: 到期日期
- shelf_life_days: 保质期天数
- storage_requirements: 存储要求(JSON)
- handling_instructions: 操作说明
- regulatory_info: 法规信息(JSON)
- status: 状态
- created_at: 创建时间
- updated_at: 更新时间
```

### 不合格品记录表 (defective_products)
```sql
- id: 主键
- defect_code: 不合格品编号
- product_id: 产品ID
- batch_number: 批次号
- defect_type: 不合格类型
- defect_level: 不合格等级
- defect_quantity: 不合格数量
- defect_description: 不合格描述
- discovery_date: 发现日期
- discovery_method: 发现方式
- responsible_party: 责任方
- isolation_status: 隔离状态
- disposal_method: 处置方式
- disposal_date: 处置日期
- cost_impact: 成本影响
- corrective_actions: 纠正措施
- preventive_measures: 预防措施
- created_by: 创建人
- created_at: 创建时间
- updated_at: 更新时间
```

## 接口设计

### 质量检验接口
**统一接口**：`POST /api/quality/inspections`

**参数说明**：`action` - 操作类型，详见 QualityInspectionAction 类型定义

#### Action字典说明
```typescript
export type QualityInspectionAction = 
  // 基础CRUD操作
  | 'create'    // 创建质量检验
  | 'list'      // 查询检验列表
  | 'detail'    // 获取检验详情
  | 'update'    // 更新检验信息
  | 'delete'    // 删除检验记录
  
  // 检验流程
  | 'draft'     // 保存草稿
  | 'submit'    // 提交检验
  | 'approve'   // 审批检验结果
  | 'reject'    // 检验拒绝
  | 'complete'  // 完成检验
  | 'cancel'    // 取消检验
  
  // 检验查询
  | 'by-product' // 按产品查询检验
  | 'by-batch'   // 按批次查询检验
  | 'by-supplier' // 按供应商查询检验
  | 'by-date'    // 按日期查询检验
  
  // 检验操作
  | 'sample'    // 抽样操作
  | 'test'      // 测试操作
  | 'record'    // 记录结果
  | 'report'    // 生成报告
  
  // 统计分析
  | 'statistics' // 检验统计分析
  | 'trends'     // 检验趋势分析
  | 'defect-analysis' // 缺陷分析
  
  // 数据管理
  | 'export'     // 检验数据导出
  | 'import'     // 检验数据导入;
```

#### 不同action的请求示例
```json
// 创建质量检验
{
  "action": "create",
  "data": {
    "product_id": 123,
    "batch_number": "BT20240320001",
    "supplier_id": 456,
    "inspection_type": "incoming",
    "sample_quantity": 50,
    "total_quantity": 1000,
    "inspection_standard": "GB/T 36276-2018"
  }
}

// 完成检验
{
  "action": "complete",
  "data": {
    "inspection_id": 789,
    "inspection_result": "qualified",
    "defect_rate": 0.02,
    "conclusion": "检验合格",
    "inspector": 101
  }
}

// 按批次查询检验
{
  "action": "by-batch",
  "params": {
    "batch_number": "BT20240320001"
  }
}

// 检验统计分析
{
  "action": "statistics",
  "params": {
    "period": "2024-Q1",
    "supplier_id": 456,
    "analysis_type": "defect_rate"
  }
}
```

### 批次追溯接口
**统一接口**：`POST /api/quality/batches`

**参数说明**：`action` - 操作类型，详见 BatchTraceabilityAction 类型定义

#### Action字典说明
```typescript
export type BatchTraceabilityAction = 
  // 基础CRUD操作
  | 'create'    // 创建批次追溯记录
  | 'list'      // 查询批次列表
  | 'detail'    // 获取批次详情
  | 'update'    // 更新批次信息
  | 'delete'    // 删除批次记录
  
  // 追溯查询
  | 'trace'     // 批次追溯查询
  | 'upstream'  // 上游追溯查询
  | 'downstream' // 下游追溯查询
  | 'flow'      // 流转轨迹查询
  | 'quality'   // 质量记录查询
  
  // 批次操作
  | 'merge'     // 批次合并
  | 'split'     // 批次拆分
  | 'transfer'  // 批次转移
  | 'archive'   // 批次归档
  
  // 问题处理
  | 'problem-identify' // 问题批次识别
  | 'impact-analysis' // 影响范围分析
  | 'isolation' // 批次隔离
  | 'recall'    // 产品召回
  
  // 统计分析
  | 'statistics' // 批次统计分析
  | 'completeness' // 追溯完整性分析
  
  // 数据管理
  | 'export'     // 批次数据导出
  | 'import'     // 批次数据导入;
```

#### 不同action的请求示例
```json
// 创建批次追溯记录
{
  "action": "create",
  "data": {
    "batch_number": "BT20240320001",
    "product_id": 123,
    "manufacturer": "宁德时代",
    "production_date": "2024-03-20",
    "production_line": "Line-01",
    "quality_grade": "A"
  }
}

// 批次追溯查询
{
  "action": "trace",
  "params": {
    "batch_number": "BT20240320001"
  }
}

// 上游追溯查询
{
  "action": "upstream",
  "params": {
    "batch_number": "BT20240320001",
    "trace_level": "raw_material"
  }
}

// 问题批次识别
{
  "action": "problem-identify",
  "data": {
    "batch_number": "BT20240320001",
    "problem_type": "quality_issue",
    "problem_description": "容量不达标"
  }
}
```

### 不合格品处理接口
**统一接口**：`POST /api/quality/defective`

**参数说明**：`action` - 操作类型，详见 DefectiveProductAction 类型定义

#### Action字典说明
```typescript
export type DefectiveProductAction = 
  // 基础CRUD操作
  | 'create'    // 创建不合格品记录
  | 'list'      // 查询不合格品列表
  | 'detail'    // 获取不合格品详情
  | 'update'    // 更新不合格品信息
  | 'delete'    // 删除不合格品记录
  
  // 不合格品处理
  | 'identify'  // 不合格品识别
  | 'isolation' // 不合格品隔离
  | 'disposal'  // 不合格品处置
  | 'rework'    // 返工处理
  | 'downgrade' // 降级使用
  | 'return'    // 退货处理
  | 'scrap'     // 报废处理
  | 'special-approval' // 特采审批
  
  // 分析处理
  | 'cause-analysis' // 原因分析
  | 'responsibility' // 责任认定
  | 'corrective-actions' // 纠正措施
  | 'preventive-measures' // 预防措施
  | 'effect-verification' // 效果验证
  
  // 成本分析
  | 'cost-analysis' // 成本影响分析
  | 'cost-calculation' // 成本计算
  
  // 统计分析
  | 'statistics' // 不合格品统计分析
  | 'trends'     // 不合格品趋势分析
  
  // 数据管理
  | 'export'     // 不合格品数据导出;
```

#### 不同action的请求示例
```json
// 创建不合格品记录
{
  "action": "create",
  "data": {
    "product_id": 123,
    "batch_number": "BT20240320001",
    "defect_type": "appearance",
    "defect_level": "major",
    "defect_quantity": 50,
    "defect_description": "外观缺陷"
  }
}

// 不合格品隔离
{
  "action": "isolation",
  "data": {
    "defect_id": 789,
    "isolation_location": "隔离区A",
    "isolation_by": 101
  }
}

// 原因分析
{
  "action": "cause-analysis",
  "data": {
    "defect_id": 789,
    "root_cause": "原材料质量问题",
    "analysis_method": "5why",
    "analyzed_by": 102
  }
}

// 成本影响分析
{
  "action": "cost-analysis",
  "params": {
    "defect_id": 789
  }
}
```

### 供应商评价接口
**统一接口**：`POST /api/quality/supplier-evaluations`

**参数说明**：`action` - 操作类型，详见 SupplierEvaluationAction 类型定义

#### Action字典说明
```typescript
export type SupplierEvaluationAction = 
  // 基础CRUD操作
  | 'create'    // 创建供应商评价
  | 'list'      // 查询评价列表
  | 'detail'    // 获取评价详情
  | 'update'    // 更新评价信息
  | 'delete'    // 删除评价记录
  
  // 评价查询
  | 'by-supplier' // 按供应商查询评价
  | 'by-period'   // 按期间查询评价
  | 'by-grade'    // 按等级查询评价
  
  // 评价操作
  | 'evaluate'  // 执行评价
  | 'auto-evaluate' // 自动评价
  | 'manual-evaluate' // 手动评价
  | 'approve'   // 评价审批
  | 'reject'    // 评价拒绝
  
  // 绩效统计
  | 'performance' // 质量绩效统计
  | 'return-rate' // 退货率统计
  | 'complaint-rate' // 投诉率统计
  | 'delivery-rate' // 交付及时率统计
  
  // 分级管理
  | 'grade'     // 供应商分级
  | 'upgrade'   // 供应商升级
  | 'downgrade' // 供应商降级
  
  // 趋势分析
  | 'trends'    // 评价趋势分析
  | 'improvement' // 改进情况分析
  
  // 统计分析
  | 'statistics' // 评价统计分析
  | 'ranking'    // 供应商排名
  
  // 数据管理
  | 'export'     // 评价数据导出;
```

#### 不同action的请求示例
```json
// 创建供应商评价
{
  "action": "create",
  "data": {
    "supplier_id": 123,
    "evaluation_period": "2024-Q1",
    "evaluation_type": "quality",
    "evaluator": 101
  }
}

// 自动评价
{
  "action": "auto-evaluate",
  "data": {
    "supplier_id": 123,
    "period": "2024-Q1",
    "evaluation_criteria": {
      "defect_rate_weight": 0.4,
      "return_rate_weight": 0.3,
      "delivery_rate_weight": 0.3
    }
  }
}

// 供应商分级
{
  "action": "grade",
  "data": {
    "supplier_id": 123,
    "new_grade": "A",
    "reason": "质量表现优秀",
    "graded_by": 102
  }
}

// 评价趋势分析
{
  "action": "trends",
  "params": {
    "supplier_id": 123,
    "period": "12months"
  }
}
```

### 质量报告接口
**统一接口**：`POST /api/quality/reports`

**参数说明**：`action` - 操作类型，详见 QualityReportAction 类型定义

#### Action字典说明
```typescript
export type QualityReportAction = 
  // 基础CRUD操作
  | 'create'    // 创建质量报告
  | 'list'      // 查询报告列表
  | 'detail'    // 获取报告详情
  | 'update'    // 更新报告信息
  | 'delete'    // 删除报告
  
  // 报告流程
  | 'draft'     // 保存草稿
  | 'submit'    // 提交报告
  | 'approve'   // 审批质量报告
  | 'reject'    // 报告拒绝
  | 'publish'   // 发布报告
  | 'cancel'    // 取消报告
  
  // 报告生成
  | 'generate'  // 生成质量报告
  | 'schedule'  // 安排报告生成
  | 'template'  // 报告模板管理
  
  // 报告类型
  | 'inspection-report' // 检验报告
  | 'defect-report' // 不合格品报告
  | 'supplier-report' // 供应商报告
  | 'trend-report' // 趋势报告
  
  // 统计分析
  | 'statistics' // 报告统计分析
  | 'usage-analysis' // 报告使用分析
  
  // 数据管理
  | 'export'     // 报告数据导出;
```

#### 不同action的请求示例
```json
// 创建质量报告
{
  "action": "create",
  "data": {
    "report_type": "monthly_quality",
    "report_period": "2024-03",
    "report_title": "2024年3月质量月报",
    "created_by": 101
  }
}

// 生成质量报告
{
  "action": "generate",
  "data": {
    "report_id": 123,
    "include_charts": true,
    "include_details": true,
    "format": "pdf"
  }
}

// 安排报告生成
{
  "action": "schedule",
  "data": {
    "report_type": "monthly_quality",
    "schedule_type": "monthly",
    "schedule_day": 1,
    "recipients": ["quality_manager", "management"]
  }
}

// 审批质量报告
{
  "action": "approve",
  "data": {
    "report_id": 123,
    "approved_by": 102,
    "comments": "报告内容准确"
  }
}
```

## 业务规则

### 质量检验规则
1. 所有入库产品必须进行质量检验
2. 检验必须按照标准程序执行
3. 检验结果必须及时记录
4. 不合格品必须立即隔离

### 批次追溯规则 - 新增
1. 每个批次必须有唯一的批次号
2. 批次信息必须完整记录
3. 批次流转必须全程跟踪
4. 问题批次必须快速定位
5. 追溯信息必须真实可靠

### 不合格品处理规则
1. 不合格品必须立即隔离
2. 不合格品处置需要审批
3. 不合格品原因必须分析
4. 改进措施必须落实
5. 预防措施必须制定

### 供应商评价规则
1. 定期进行质量评价
2. 评价结果及时反馈
3. 评价结果影响合作
4. 帮助供应商改进
5. 建立长期合作关系

## 关键业务流程

### 入库检验流程
```
收货验收 → 质量检验 → 合格判定 → 入库确认 → 批次建档
```

### 批次追溯流程 - 新增
```
批次创建 → 信息录入 → 流转跟踪 → 追溯查询 → 问题处理
```

### 不合格品处理流程
```
问题发现 → 立即隔离 → 原因分析 → 处置审批 → 处置执行 → 改进措施
```

### 供应商评价流程
```
数据收集 → 绩效统计 → 质量评价 → 结果反馈 → 改进建议 → 跟踪改进
```

## 权限控制

### 质量检验权限
- **检验执行**：质量检验员
- **检验审核**：质量主管
- **检验标准**：质量工程师
- **检验设备**：设备管理员

### 批次追溯权限 - 新增
- **批次创建**：质量工程师、仓库管理员
- **信息录入**：质量工程师、仓库管理员
- **追溯查询**：所有业务人员
- **问题处理**：质量主管、管理层

### 不合格品处理权限
- **问题发现**：所有业务人员
- **隔离操作**：仓库管理员
- **处置审批**：质量主管、管理层
- **处置执行**：仓库管理员

### 供应商评价权限
- **数据收集**：质量部门、采购部门
- **绩效统计**：质量工程师
- **评价执行**：质量主管
- **结果应用**：管理层、采购部门

## 报表功能

### 质量检验报表
- **检验统计报表**：检验数量、合格率统计
- **检验趋势报表**：质量趋势分析
- **检验成本报表**：检验成本分析
- **检验效率报表**：检验效率分析

### 批次追溯报表 - 新增
- **批次统计报表**：批次数量、分布统计
- **追溯效率报表**：追溯查询效率分析
- **问题批次报表**：问题批次统计和分析
- **追溯完整性报表**：追溯信息完整性分析

### 不合格品报表
- **不合格品统计**：不合格品数量、类型统计
- **不合格原因分析**：不合格原因分析
- **不合格成本分析**：不合格品成本分析
- **改进效果分析**：改进措施效果分析

### 供应商质量报表
- **供应商绩效报表**：供应商质量绩效统计
- **供应商排名报表**：供应商质量排名
- **供应商趋势报表**：供应商质量趋势分析
- **供应商改进报表**：供应商改进情况分析

## 系统集成

### 与库存管理集成
- **批次信息同步**：批次信息与库存信息同步
- **质量状态更新**：质量状态影响库存状态
- **不合格品隔离**：不合格品自动隔离

### 与采购管理集成
- **供应商信息**：共享供应商基本信息
- **采购订单**：采购订单触发质量检验
- **供应商评价**：质量评价影响采购决策

### 与销售管理集成
- **客户要求**：客户质量要求影响检验标准
- **质量承诺**：质量承诺影响销售策略
- **客户反馈**：客户反馈影响质量改进

## 技术实现

### 数据库设计
- **主键设计**：使用自增主键
- **索引优化**：为查询字段建立索引
- **分区策略**：大表按时间分区
- **备份策略**：定期备份重要数据

### 缓存策略
- **热点数据缓存**：缓存频繁查询的数据
- **查询结果缓存**：缓存复杂查询结果
- **缓存更新策略**：及时更新缓存数据

### 性能优化
- **查询优化**：优化复杂查询语句
- **索引优化**：合理使用数据库索引
- **分页查询**：大数据量分页查询
- **异步处理**：耗时操作异步处理

---

**文档版本**: 1.0.1  
**最后更新**: 2025-08-24  
**维护人员**: 质量控制团队
