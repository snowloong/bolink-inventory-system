<!--
 * @Author: snowloong iamfinleyyao1997@163.com
 * @Date: 2025-08-24 14:22:32
 * @LastEditors: snowloong iamfinleyyao1997@163.com
 * @LastEditTime: 2025-08-24 15:52:06
 * @FilePath: /wiki-snowloog/bolink-inventory-system/08-系统管理模块.md
 * @Description: 
 * 
-->
# @bolink-inventory-system/system - 系统管理模块

## 模块概述
系统管理模块负责整个进销存系统的基础管理功能，包括用户权限管理、系统配置、数据安全、以及与外部系统的集成，为其他业务模块提供稳定可靠的技术支撑。

## 核心功能

### 1. 用户权限管理

#### 1.1 用户管理
- **用户账户管理**：用户注册、激活、禁用、删除
- **用户信息维护**：基本信息、联系方式、部门归属
- **密码策略管理**：密码复杂度、有效期、历史密码
- **登录安全管理**：登录失败锁定、异地登录提醒
- **用户状态管理**：在线状态、最后登录时间

#### 1.2 角色管理
- **角色定义**：定义不同的系统角色
- **角色层次**：建立角色的层次关系
- **角色继承**：上级角色继承下级角色权限
- **角色模板**：预定义常用角色模板
- **动态角色**：基于条件的动态角色分配

#### 1.3 权限控制
- **功能权限**：控制用户对功能模块的访问
- **数据权限**：控制用户对数据范围的访问
- **操作权限**：控制用户的具体操作权限
- **字段权限**：控制用户对敏感字段的访问
- **时间权限**：基于时间的权限控制

#### 1.4 审计跟踪
- **登录日志**：记录用户登录、退出日志
- **操作日志**：记录用户的详细操作记录（按季度分区存储）
- **权限变更日志**：记录权限分配和变更
- **数据变更日志**：记录重要数据的变更历史
- **异常行为日志**：记录异常的用户行为

### 2. 基础配置管理

#### 2.1 系统参数配置
- **业务参数**：业务流程相关的参数配置
- **系统参数**：系统运行相关的参数配置
- **安全参数**：安全策略相关的参数配置
- **性能参数**：系统性能调优参数
- **接口参数**：外部接口相关的参数配置
- **库存参数**：库存预警、预留过期等参数配置

#### 2.2 业务流程配置
- **审批流程**：各种业务的审批流程配置
- **通知流程**：系统通知和提醒的流程配置
- **自动化流程**：自动化业务流程的配置
- **例外处理流程**：异常情况的处理流程
- **流程版本管理**：业务流程的版本控制

#### 2.3 提醒设置
- **库存预警**：库存不足、过多的预警设置
- **业务提醒**：订单、合同等业务提醒
- **系统通知**：系统维护、更新等通知
- **个人提醒**：用户个人相关的提醒设置
- **提醒方式**：邮件、短信、系统内通知

#### 2.4 打印模板管理
- **单据模板**：各种业务单据的打印模板
- **报表模板**：报表的打印格式模板
- **标签模板**：产品标签、条码的打印模板
- **模板版本控制**：模板的版本管理
- **自定义模板**：支持用户自定义打印模板

### 3. 数据备份与安全

#### 3.1 数据备份管理
- **自动备份**：定时自动备份数据库
- **手动备份**：支持手动触发数据备份
- **增量备份**：支持增量备份策略
- **备份验证**：验证备份文件的完整性
- **备份存储**：本地和远程备份存储

#### 3.2 数据恢复管理
- **完整恢复**：从完整备份恢复数据
- **点位恢复**：恢复到指定时间点
- **选择性恢复**：恢复特定数据或表
- **恢复测试**：定期测试数据恢复
- **恢复日志**：记录恢复操作的详细日志

#### 3.3 数据安全管理
- **数据加密**：敏感数据的加密存储
- **传输加密**：数据传输过程的加密
- **访问控制**：严格的数据访问控制
- **数据脱敏**：测试环境的数据脱敏
- **安全审计**：数据安全的审计跟踪

#### 3.4 版本控制
- **系统版本管理**：系统版本的管理和升级
- **数据库版本控制**：数据库结构的版本控制
- **配置版本管理**：系统配置的版本管理
- **代码版本控制**：与代码仓库的集成
- **回滚机制**：支持版本回滚操作

### 4. 接口管理

#### 4.1 ERP系统集成
- **主数据同步**：与ERP系统的主数据同步
- **业务数据交换**：订单、库存等业务数据交换
- **财务数据集成**：与财务模块的数据集成
- **实时接口**：支持实时数据交换
- **批量接口**：支持批量数据处理

#### 4.2 物流系统对接
- **物流信息推送**：向物流系统推送发货信息
- **运输状态跟踪**：获取物流运输状态
- **签收信息回传**：获取客户签收信息
- **运费结算**：与物流公司的运费结算
- **异常处理**：物流异常情况的处理

#### 4.3 第三方系统集成
- **电商平台对接**：与电商平台的订单同步
- **银行系统对接**：与银行的支付结算对接
- **税务系统对接**：与税务系统的数据交换
- **监管系统对接**：与行业监管系统的对接
- **供应商系统对接**：与供应商系统的数据交换

#### 4.4 API管理
- **接口文档管理**：API接口的文档管理
- **接口版本控制**：API版本的管理和兼容
- **接口监控**：API调用的监控和统计
- **接口安全**：API访问的安全控制
- **接口测试**：API接口的自动化测试

## 数据模型设计

### 用户表 (users)
```sql
- id: 主键
- username: 用户名
- password_hash: 密码哈希
- email: 邮箱
- phone: 电话
- full_name: 姓名
- department_id: 部门ID
- position: 职位
- status: 状态
- last_login_time: 最后登录时间
- password_changed_at: 密码修改时间
- failed_login_attempts: 登录失败次数
- locked_until: 锁定到期时间
- created_at: 创建时间
- updated_at: 更新时间
```

### 角色表 (roles)
```sql
- id: 主键
- role_code: 角色编码
- role_name: 角色名称
- description: 角色描述
- parent_role_id: 上级角色ID
- level: 角色层级
- is_system_role: 是否系统角色
- status: 状态
- created_at: 创建时间
- updated_at: 更新时间
```

### 权限表 (permissions)
```sql
- id: 主键
- permission_code: 权限编码
- permission_name: 权限名称
- permission_type: 权限类型
- resource: 资源
- action: 操作
- description: 描述
- parent_permission_id: 上级权限ID
- sort_order: 排序
- status: 状态
- created_at: 创建时间
```

### 用户角色关联表 (user_roles)
```sql
- id: 主键
- user_id: 用户ID
- role_id: 角色ID
- assigned_by: 分配人
- assigned_at: 分配时间
- expires_at: 到期时间
- status: 状态
```

### 角色权限关联表 (role_permissions)
```sql
- id: 主键
- role_id: 角色ID
- permission_id: 权限ID
- granted: 是否授权
- granted_by: 授权人
- granted_at: 授权时间
```

### 操作日志表 (operation_logs)
```sql
- id: 主键
- user_id: 用户ID
- operation_type: 操作类型
- resource: 操作资源
- action: 操作动作
- resource_id: 资源ID
- old_values: 原值(JSON)
- new_values: 新值(JSON)
- ip_address: IP地址
- user_agent: 用户代理
- operation_time: 操作时间
- operation_result: 操作结果
- error_message: 错误信息
```

### 系统配置表 (system_configs)
```sql
- id: 主键
- config_key: 配置键
- config_value: 配置值
- config_type: 配置类型
- category: 配置分类
- description: 配置描述
- is_encrypted: 是否加密
- is_readonly: 是否只读
- updated_by: 更新人
- updated_at: 更新时间
```

### 备份记录表 (backup_records)
```sql
- id: 主键
- backup_code: 备份编号
- backup_type: 备份类型
- backup_scope: 备份范围
- file_path: 文件路径
- file_size: 文件大小
- start_time: 开始时间
- end_time: 结束时间
- status: 备份状态
- error_message: 错误信息
- created_by: 创建人
- created_at: 创建时间
```

### 接口配置表 (interface_configs)
```sql
- id: 主键
- interface_code: 接口编码
- interface_name: 接口名称
- interface_type: 接口类型
- endpoint_url: 接口地址
- auth_method: 认证方式
- auth_config: 认证配置(JSON)
- timeout: 超时时间
- retry_times: 重试次数
- is_active: 是否启用
- created_by: 创建人
- created_at: 创建时间
```

## 接口设计

### 用户管理接口
**统一接口**：`POST /api/system/users`

**参数说明**：`action` - 操作类型，详见 UserManagementAction 类型定义

#### Action字典说明
```typescript
export type UserManagementAction = 
  // 基础CRUD操作
  | 'create'    // 创建用户
  | 'list'      // 查询用户列表
  | 'detail'    // 获取用户详情
  | 'update'    // 更新用户信息
  | 'delete'    // 删除用户
  
  // 用户操作
  | 'batch'     // 批量操作用户
  | 'reset-password' // 重置密码
  | 'change-password' // 修改密码
  | 'lock'      // 锁定用户
  | 'unlock'    // 解锁用户
  | 'activate'  // 激活用户
  | 'deactivate' // 停用用户
  
  // 用户查询
  | 'by-department' // 按部门查询用户
  | 'by-role'   // 按角色查询用户
  | 'by-status' // 按状态查询用户
  
  // 登录管理
  | 'login-history' // 获取登录历史
  | 'logout'    // 强制登出
  | 'online-users' // 在线用户查询
  
  // 统计分析
  | 'statistics' // 用户统计分析
  | 'activity-analysis' // 用户活动分析
  
  // 数据管理
  | 'export'     // 用户数据导出
  | 'import'     // 用户数据导入;
```

#### 不同action的请求示例
```json
// 创建用户
{
  "action": "create",
  "data": {
    "username": "zhangsan",
    "email": "zhangsan@example.com",
    "full_name": "张三",
    "department_id": 123,
    "position": "仓库管理员",
    "password": "SecurePass123!"
  }
}

// 重置密码
{
  "action": "reset-password",
  "data": {
    "user_id": 456,
    "new_password": "NewSecurePass123!",
    "force_change": true
  }
}

// 锁定用户
{
  "action": "lock",
  "data": {
    "user_id": 456,
    "reason": "安全策略违规",
    "locked_by": 101
  }
}

// 查询用户列表
{
  "action": "list",
  "params": {
    "page": 1,
    "size": 20,
    "department_id": 123,
    "status": "active"
  }
}

// 用户统计分析
{
  "action": "statistics",
  "params": {
    "period": "2024-Q1",
    "analysis_type": "login_frequency"
  }
}
```

### 角色管理接口
**统一接口**：`POST /api/system/roles`

**参数说明**：`action` - 操作类型，详见 RoleManagementAction 类型定义

#### Action字典说明
```typescript
export type RoleManagementAction = 
  // 基础CRUD操作
  | 'create'    // 创建角色
  | 'list'      // 查询角色列表
  | 'detail'    // 获取角色详情
  | 'update'    // 更新角色信息
  | 'delete'    // 删除角色
  
  // 角色操作
  | 'clone'     // 克隆角色
  | 'enable'    // 启用角色
  | 'disable'   // 禁用角色
  | 'archive'   // 归档角色
  
  // 权限管理
  | 'permissions' // 获取角色权限
  | 'assign-permissions' // 分配角色权限
  | 'remove-permissions' // 移除角色权限
  | 'inherit-permissions' // 继承权限管理
  
  // 用户管理
  | 'users'     // 获取角色用户
  | 'assign-users' // 分配用户到角色
  | 'remove-users' // 从角色移除用户
  
  // 角色查询
  | 'by-level'  // 按层级查询角色
  | 'by-type'   // 按类型查询角色
  
  // 统计分析
  | 'statistics' // 角色使用统计
  | 'usage-analysis' // 使用情况分析
  
  // 数据管理
  | 'export'     // 角色数据导出
  | 'import'     // 角色数据导入;
```

#### 不同action的请求示例
```json
// 创建角色
{
  "action": "create",
  "data": {
    "role_code": "WAREHOUSE_MANAGER",
    "role_name": "仓库经理",
    "description": "负责仓库日常管理",
    "parent_role_id": 123,
    "level": 2
  }
}

// 分配角色权限
{
  "action": "assign-permissions",
  "data": {
    "role_id": 456,
    "permission_ids": [101, 102, 103],
    "assigned_by": 101
  }
}

// 分配用户到角色
{
  "action": "assign-users",
  "data": {
    "role_id": 456,
    "user_ids": [201, 202, 203],
    "assigned_by": 101
  }
}

// 角色使用统计
{
  "action": "statistics",
  "params": {
    "role_id": 456,
    "period": "2024-Q1"
  }
}
```

### 权限管理接口
**统一接口**：`POST /api/system/permissions`

**参数说明**：`action` - 操作类型，详见 PermissionManagementAction 类型定义

#### Action字典说明
```typescript
export type PermissionManagementAction = 
  // 基础CRUD操作
  | 'create'    // 创建权限
  | 'list'      // 查询权限列表
  | 'detail'    // 获取权限详情
  | 'update'    // 更新权限信息
  | 'delete'    // 删除权限
  
  // 权限操作
  | 'tree'      // 获取权限树
  | 'validate'  // 验证权限配置
  | 'modules'   // 获取模块权限
  | 'dynamic'   // 动态权限控制
  
  // 继承管理
  | 'inheritance' // 权限继承管理
  | 'set-inheritance' // 设置权限继承
  | 'remove-inheritance' // 移除权限继承
  
  // 权限查询
  | 'by-type'   // 按类型查询权限
  | 'by-resource' // 按资源查询权限
  | 'by-module' // 按模块查询权限
  
  // 统计分析
  | 'statistics' // 权限使用统计
  | 'access-analysis' // 访问情况分析
  
  // 数据管理
  | 'export'     // 权限数据导出
  | 'import'     // 权限数据导入;
```

#### 不同action的请求示例
```json
// 创建权限
{
  "action": "create",
  "data": {
    "permission_code": "INVENTORY_VIEW",
    "permission_name": "库存查看",
    "permission_type": "function",
    "resource": "inventory",
    "action": "view",
    "description": "查看库存信息权限"
  }
}

// 获取权限树
{
  "action": "tree",
  "params": {
    "module": "inventory"
  }
}

// 设置权限继承
{
  "action": "set-inheritance",
  "data": {
    "parent_permission_id": 123,
    "child_permission_id": 456
  }
}

// 权限使用统计
{
  "action": "statistics",
  "params": {
    "period": "2024-Q1",
    "permission_type": "function"
  }
}
```

### 系统配置接口
**统一接口**：`POST /api/system/configs`

**参数说明**：`action` - 操作类型，详见 SystemConfigAction 类型定义

#### Action字典说明
```typescript
export type SystemConfigAction = 
  // 基础CRUD操作
  | 'create'    // 创建系统配置
  | 'list'      // 查询配置列表
  | 'detail'    // 获取配置详情
  | 'update'    // 更新配置信息
  | 'delete'    // 删除配置
  
  // 配置操作
  | 'groups'    // 获取配置分组
  | 'group'     // 获取分组配置
  | 'batch-update' // 批量更新配置
  | 'refresh'   // 刷新配置缓存
  
  // 配置管理
  | 'backup'    // 备份配置
  | 'restore'   // 恢复配置
  | 'validate'  // 验证配置
  | 'rollback'  // 配置回滚
  
  // 配置查询
  | 'by-category' // 按分类查询配置
  | 'by-type'   // 按类型查询配置
  
  // 统计分析
  | 'statistics' // 配置使用统计
  | 'change-history' // 配置变更历史
  
  // 数据管理
  | 'export'     // 配置数据导出
  | 'import'     // 配置数据导入;
```

#### 不同action的请求示例
```json
// 创建系统配置
{
  "action": "create",
  "data": {
    "config_key": "inventory.alert.threshold",
    "config_value": "100",
    "config_type": "integer",
    "category": "inventory",
    "description": "库存预警阈值"
  }
}

// 批量更新配置
{
  "action": "batch-update",
  "data": {
    "configs": [
      {
        "config_key": "inventory.alert.threshold",
        "config_value": "150"
      },
      {
        "config_key": "inventory.reservation.expire_days",
        "config_value": "7"
      }
    ],
    "updated_by": 101
  }
}

// 刷新配置缓存
{
  "action": "refresh",
  "data": {
    "cache_keys": ["inventory", "system"],
    "force_refresh": true
  }
}

// 配置变更历史
{
  "action": "change-history",
  "params": {
    "config_key": "inventory.alert.threshold",
    "start_date": "2024-03-01",
    "end_date": "2024-03-31"
  }
}
```

### 操作日志接口
**统一接口**：`POST /api/system/operation-logs`

**参数说明**：`action` - 操作类型，详见 OperationLogAction 类型定义

#### Action字典说明
```typescript
export type OperationLogAction = 
  // 基础CRUD操作
  | 'create'    // 创建操作日志
  | 'list'      // 查询日志列表
  | 'detail'    // 获取日志详情
  | 'update'    // 更新日志信息
  | 'delete'    // 删除日志
  
  // 日志查询
  | 'by-user'   // 获取用户操作日志
  | 'by-module' // 获取模块操作日志
  | 'by-date'   // 按日期范围查询
  | 'search'    // 高级搜索日志
  
  // 日志分析
  | 'statistics' // 日志统计分析
  | 'trends'     // 操作趋势分析
  | 'anomaly'    // 异常操作分析
  
  // 日志管理
  | 'cleanup'   // 清理历史日志
  | 'archive'   // 归档日志
  | 'export'    // 日志数据导出
  | 'backup'    // 日志备份;
```

#### 不同action的请求示例
```json
// 创建操作日志
{
  "action": "create",
  "data": {
    "user_id": 101,
    "operation_type": "update",
    "resource": "inventory",
    "action": "update_stock",
    "resource_id": 123,
    "old_values": {"quantity": 100},
    "new_values": {"quantity": 150},
    "ip_address": "192.168.1.100"
  }
}

// 高级搜索日志
{
  "action": "search",
  "data": {
    "user_id": 101,
    "operation_type": "update",
    "resource": "inventory",
    "start_time": "2024-03-01T00:00:00Z",
    "end_time": "2024-03-31T23:59:59Z",
    "ip_address": "192.168.1.100"
  }
}

// 日志统计分析
{
  "action": "statistics",
  "params": {
    "period": "2024-Q1",
    "analysis_type": "operation_frequency"
  }
}

// 清理历史日志
{
  "action": "cleanup",
  "data": {
    "before_date": "2024-01-01",
    "log_types": ["operation", "login"],
    "batch_size": 1000
  }
}
```

### 数据备份接口
**统一接口**：`POST /api/system/backups`

**参数说明**：`action` - 操作类型，详见 DataBackupAction 类型定义

#### Action字典说明
```typescript
export type DataBackupAction = 
  // 基础CRUD操作
  | 'create'    // 创建数据备份
  | 'list'      // 查询备份记录列表
  | 'detail'    // 获取备份详情
  | 'update'    // 更新备份信息
  | 'delete'    // 删除备份
  
  // 备份操作
  | 'download'  // 下载备份文件
  | 'restore'   // 恢复数据备份
  | 'incremental' // 增量备份
  | 'full'      // 全量备份
  | 'verify'    // 验证备份完整性
  
  // 备份管理
  | 'schedule'  // 获取备份计划
  | 'set-schedule' // 设置备份计划
  | 'test-restore' // 测试恢复
  | 'cleanup'   // 清理过期备份
  
  // 统计分析
  | 'statistics' // 备份统计分析
  | 'performance' // 备份性能分析
  
  // 数据管理
  | 'export'     // 备份记录导出;
```

#### 不同action的请求示例
```json
// 创建数据备份
{
  "action": "create",
  "data": {
    "backup_type": "full",
    "backup_scope": "all",
    "description": "系统完整备份",
    "created_by": 101
  }
}

// 恢复数据备份
{
  "action": "restore",
  "data": {
    "backup_id": 123,
    "restore_scope": "inventory_data",
    "restore_to_date": "2024-03-25T10:00:00Z",
    "restored_by": 101
  }
}

// 设置备份计划
{
  "action": "set-schedule",
  "data": {
    "schedule_type": "daily",
    "backup_time": "02:00",
    "backup_type": "incremental",
    "retention_days": 30,
    "enabled": true
  }
}

// 备份统计分析
{
  "action": "statistics",
  "params": {
    "period": "2024-Q1",
    "backup_type": "full"
  }
}
```

### 系统监控接口
**统一接口**：`POST /api/system/monitoring`

**参数说明**：`action` - 操作类型，详见 SystemMonitoringAction 类型定义

#### Action字典说明
```typescript
export type SystemMonitoringAction = 
  // 健康检查
  | 'health'    // 系统健康检查
  | 'status'    // 系统状态检查
  
  // 性能监控
  | 'performance' // 系统性能监控
  | 'resources'  // 资源使用监控
  | 'database'   // 数据库监控
  | 'cache'      // 缓存监控
  | 'queue'      // 队列监控
  
  // 告警管理
  | 'alerts'    // 系统告警
  | 'acknowledge' // 确认告警
  | 'resolve'   // 解决告警
  | 'escalate'  // 升级告警
  
  // 指标管理
  | 'metrics'   // 系统指标
  | 'collect'   // 收集指标
  | 'dashboard' // 监控仪表板
  
  // 数据分析
  | 'trends'    // 趋势分析
  | 'anomaly'   // 异常检测
  | 'capacity'  // 容量分析
  
  // 数据管理
  | 'export'     // 监控数据导出;
```

#### 不同action的请求示例
```json
// 系统健康检查
{
  "action": "health",
  "params": {
    "check_components": ["database", "cache", "queue"]
  }
}

// 系统性能监控
{
  "action": "performance",
  "params": {
    "metrics": ["cpu_usage", "memory_usage", "disk_usage"],
    "time_range": "1hour"
  }
}

// 确认告警
{
  "action": "acknowledge",
  "data": {
    "alert_id": 123,
    "acknowledged_by": 101,
    "comments": "正在处理中"
  }
}

// 收集指标
{
  "action": "collect",
  "data": {
    "metric_name": "api_response_time",
    "metric_value": 150,
    "timestamp": "2024-03-25T10:30:00Z",
    "tags": {
      "endpoint": "/api/inventory/stock",
      "method": "POST"
    }
  }
}
```

## 业务规则

### 用户管理规则
1. 用户名必须唯一且不能修改
2. 密码必须符合安全策略
3. 连续登录失败5次将锁定账户
4. 管理员账户不能被删除

### 权限管理规则
1. 系统角色不能被删除或修改
2. 权限分配需要相应的管理权限
3. 用户权限是角色权限的并集
4. 敏感操作需要二次验证

### 配置管理规则
1. 系统核心配置需要管理员权限
2. 配置变更需要记录变更日志
3. 关键配置变更需要重启生效
4. 配置支持环境隔离

### 备份管理规则
1. 自动备份每天凌晨执行
2. 备份文件保留30天
3. 重要操作前自动创建备份点
4. 恢复操作需要双人确认

## 关键业务流程

### 用户权限分配流程
```
用户申请 → 部门审核 → 权限评估 → 权限分配 → 权限确认 → 权限生效
```

### 系统配置变更流程
```
变更申请 → 影响评估 → 变更审批 → 配置备份 → 配置变更 → 效果验证
```

### 数据备份恢复流程
```
备份计划 → 备份执行 → 备份验证 → 备份存储 → 恢复测试 → 记录归档
```

### 接口集成流程
```
需求分析 → 接口设计 → 接口开发 → 接口测试 → 接口部署 → 监控维护
```

## 权限控制

### 用户管理权限
- **查看权限**：人事、系统管理员
- **创建权限**：系统管理员、人事主管
- **修改权限**：系统管理员、人事主管
- **删除权限**：系统管理员

### 角色权限管理权限
- **查看权限**：系统管理员、安全管理员
- **分配权限**：系统管理员
- **修改权限**：系统管理员
- **审计权限**：安全管理员

### 系统配置权限
- **查看权限**：系统管理员、运维人员
- **修改权限**：系统管理员
- **备份权限**：系统管理员、运维人员
- **恢复权限**：系统管理员

### 接口管理权限
- **查看权限**：系统管理员、开发人员
- **配置权限**：系统管理员
- **测试权限**：系统管理员、开发人员
- **监控权限**：运维人员、系统管理员
