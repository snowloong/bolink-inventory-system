# 数据库初始化说明

## 📋 概述

`database-init-complete.sql` 是新能源电池进销存系统的完整数据库初始化脚本，包含了清理和创建两个阶段，可以安全地重复执行。

### 与统一API设计的关系
- **数据基础**: 数据库初始化脚本为统一API设计提供完整的数据模型基础
- **表结构支持**: 50个表的设计支持42个统一API接口的所有操作需求
- **函数支撑**: 12个PL/pgSQL函数为统一API的复杂业务逻辑提供数据库层支持
- **视图优化**: 7个视图+1个物化视图为统一API的统计查询提供性能优化
- **触发器保障**: 32个触发器确保统一API操作的数据一致性和完整性

## 🚀 快速开始

### 1. 环境准备
- PostgreSQL 14+ 数据库
- 具有创建表、函数、视图权限的数据库用户
- 足够的磁盘空间（建议至少1GB）

### 2. 执行初始化

```bash
# 方法1：使用psql命令行
psql -h localhost -U your_username -d your_database -f database-init-complete.sql

# 方法2：使用pgAdmin或其他数据库管理工具
# 直接执行 database-init-complete.sql 文件内容
```

### 3. 验证初始化结果

```bash
# 执行测试脚本验证
psql -h localhost -U your_username -d your_database -f test-init.sql
```

## 🔧 脚本功能

### 清理阶段
脚本会自动删除以下已存在的数据库对象：

#### 视图和物化视图
- `mv_inventory_summary` - 库存汇总物化视图
- `view_inventory_alerts` - 库存预警视图
- `view_expiring_inventory` - 即将过期库存视图
- `view_order_completion` - 订单完成度视图
- `view_supplier_performance` - 供应商业绩视图
- `view_customer_sales` - 客户销售视图
- `view_product_sales` - 产品销售视图

#### 触发器
- 所有表的 `updated_at` 更新时间戳触发器
- 库存流水触发器
- 其他业务触发器

#### 函数
- `update_updated_at_column()` - 更新时间戳函数
- `update_inventory_from_transaction()` - 库存更新函数
- `auto_expire_reservations()` - 自动释放预留函数
- `get_available_inventory()` - 获取可用库存函数
- `validate_product_code()` - 验证产品编码函数
- `validate_supplier_code()` - 验证供应商编码函数
- `validate_customer_code()` - 验证客户编码函数
- `calculate_inventory_turnover()` - 计算库存周转率函数
- `create_quarterly_partition()` - 创建季度分区函数
- `auto_create_log_partitions()` - 自动创建日志分区函数
- `cleanup_old_log_partitions()` - 清理旧分区函数

#### 表（按依赖关系倒序删除）
- 业务表：客户回访、退换货、仪表板配置等
- 统计表：指标数据、分析指标、定时任务等
- 安全表：安全检查、环境监控、危险品运输等
- 业务表：出库、收货、价格历史、供应商评估等
- 核心表：库存、订单、产品、供应商、客户等
- 系统表：用户、角色、权限、配置等
- 分区表：操作日志分区表

### 创建阶段
脚本会按正确顺序创建所有数据库对象：

#### 第一步：创建数据库扩展
- `uuid-ossp` - UUID生成扩展
- `pgcrypto` - 加密扩展

#### 第二步：创建基础函数
- 12个PL/pgSQL函数

#### 第三步：创建基础数据表
- 产品、供应商、客户、仓库等基础表

#### 第四步：创建业务表
- 库存、订单、质量、安全等业务表

#### 第五步：创建操作日志表
- 操作日志主表和分区表

#### 第六步：创建安全管理表
- 安全检查、环境监控、危险品运输等

#### 第七步：创建报表统计表
- 报表模板、生成记录、定时任务等

#### 第八步：创建补充业务表
- 退换货、客户回访等

#### 第九步：添加约束
- 数据完整性约束
- 业务规则约束

#### 第十步：创建索引
- 185个索引（单列、复合、部分、函数、JSON等）

#### 第十一步：创建触发器
- 32个触发器

#### 第十二步：创建视图
- 7个视图 + 1个物化视图

#### 第十三步：插入初始数据
- 系统用户、角色、权限
- 示例产品、供应商、客户数据
- 示例库存、价格、评估数据
- 示例安全、报表配置数据

## 📊 初始化结果

执行完成后，数据库将包含：

### 表结构
- **50个表**（包括4个分区表）
- **185个索引**
- **32个触发器**
- **7个视图 + 1个物化视图**
- **12个函数**

### 初始数据
- **系统管理员账户**：admin / admin123
- **基础角色**：管理员、管理者、普通用户等
- **示例产品**：磷酸铁锂电池、三元锂电池等
- **示例供应商**：宁德时代、比亚迪、国轩高科等
- **示例客户**：特斯拉、蔚来、阳光电源等
- **示例仓库**：北京主仓库、上海分仓库等
- **示例库存**：各种产品的库存数据
- **示例配置**：系统配置、报表模板、仪表板等

## ⚠️ 注意事项

### 1. 数据备份
执行前请备份重要数据：
```sql
-- 备份整个数据库
pg_dump -h localhost -U your_username -d your_database > backup_before_init.sql
```

### 2. 权限要求
确保数据库用户具有以下权限：
- CREATE TABLE
- CREATE FUNCTION
- CREATE VIEW
- CREATE TRIGGER
- CREATE INDEX
- DROP TABLE
- DROP FUNCTION
- DROP VIEW
- DROP TRIGGER

### 3. 执行时间
- 首次执行：约2-5分钟
- 重复执行：约1-3分钟（包含清理时间）

### 4. 错误处理
如果执行过程中出现错误：
1. 检查数据库连接和权限
2. 查看错误日志
3. 手动清理残留对象
4. 重新执行脚本

## 🔍 故障排除

### 常见问题

#### 1. 权限不足
```
ERROR: permission denied for schema public
```
**解决方案**：确保用户具有足够的权限

#### 2. 对象已存在
```
ERROR: relation "table_name" already exists
```
**解决方案**：脚本会自动处理，如果仍有问题，手动删除对象

#### 3. 外键约束错误
```
ERROR: insert or update on table violates foreign key constraint
```
**解决方案**：检查初始数据的依赖关系

#### 4. 扩展不存在
```
ERROR: extension "uuid-ossp" is not available
```
**解决方案**：安装PostgreSQL扩展包

### 手动清理
如果自动清理失败，可以手动执行：

```sql
-- 删除所有相关表（谨慎操作）
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
GRANT ALL ON SCHEMA public TO your_username;
```

## 📞 技术支持

如果遇到问题，请：
1. 查看PostgreSQL错误日志
2. 检查数据库版本兼容性
3. 确认用户权限设置
4. 联系技术支持团队

---

**文档版本**: 1.0.1  
**最后更新**: 2025-08-24  
**适用版本**: PostgreSQL 14+
