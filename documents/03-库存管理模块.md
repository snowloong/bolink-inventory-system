# @bolink-inventory-system/inventory - 库存管理模块

## 模块概述
库存管理模块是进销存系统的核心，负责库存数据的实时维护、库存策略的执行、以及库存相关业务流程的管理，确保库存数据的准确性和库存操作的高效性。

## 核心功能

### 1. 库存监控管理

#### 1.1 实时库存查询
- **库存总览**：全部产品的库存状态一览
- **产品库存详情**：单个产品的库存明细信息
- **批次库存查询**：按批次查看库存分布
- **仓库库存分布**：多仓库库存分布情况
- **在途库存管理**：采购在途、调拨在途库存

#### 1.2 库存预警系统
- **安全库存设置**：为每个产品设置安全库存量
- **最小库存预警**：库存低于安全线时自动预警
- **最大库存预警**：库存超过最大限制时预警
- **呆滞库存预警**：长期无流动的库存预警
- **过期库存预警**：接近保质期的产品预警

#### 1.3 库存分析报表
- **库存周转分析**：计算库存周转率和周转天数
- **ABC分析**：按价值对库存产品进行ABC分类
- **库存结构分析**：按产品类型、供应商等维度分析
- **库存趋势分析**：库存变化趋势和季节性分析

#### 1.4 多仓库统一管理
- **跨仓库库存查询**：统一查看所有仓库库存
- **仓库间库存对比**：对比各仓库库存情况
- **库存分配策略**：新到货在各仓库的分配策略
- **虚拟库存管理**：客户寄存、代管库存管理

### 2. 批次管理

#### 2.1 批次信息管理
- **批次档案建立**：记录批次基本信息和属性
- **生产批次信息**：生产日期、生产厂家、生产工艺
- **质量批次信息**：检验日期、检验结果、质量等级
- **采购批次信息**：采购日期、供应商、采购价格

#### 2.2 有效期管理
- **保质期设置**：为每个产品设置保质期规则
- **有效期跟踪**：实时跟踪产品剩余有效期
- **临期预警**：临近保质期的产品预警提醒
- **过期处理**：过期产品的隔离和处理流程

#### 2.3 先进先出(FIFO)策略
- **出库优先级**：按批次生产日期确定出库顺序
- **系统推荐**：出库时自动推荐最早批次
- **强制执行**：系统强制执行FIFO策略
- **例外处理**：特殊情况下的例外出库审批

#### 2.4 批次追溯管理
- **上游追溯**：追溯到原材料供应商和生产信息
- **下游追溯**：追溯到最终客户和销售信息
- **问题批次定位**：快速定位有问题的批次
- **召回管理**：问题产品的召回处理流程

### 3. 库位管理

#### 3.1 库位规划设计
- **库区划分**：收货区、存储区、拣货区、发货区
- **货架布局**：货架类型、层数、承重规划
- **库位编码**：标准化的库位编码规则
- **通道设计**：叉车通道、人行通道规划

#### 3.2 货位分配管理
- **自动分配**：系统根据规则自动分配货位
- **手动调整**：人工调整货位分配
- **货位预留**：为特定产品或客户预留货位
- **货位优化**：根据出库频率优化货位布局

#### 3.3 盘点管理
- **盘点计划**：制定定期和临时盘点计划
- **盘点执行**：扫码盘点、数量核对
- **差异处理**：盘点差异的分析和处理
- **盘点报告**：盘点结果统计和分析报告

#### 3.4 移库作业管理
- **移库申请**：因货位调整、维修等移库申请
- **移库审批**：移库作业的审批流程
- **移库执行**：移库作业的执行和确认
- **移库记录**：移库历史记录和轨迹追踪

### 4. 库存调拨管理

#### 4.1 调拨需求管理
- **调拨申请**：各仓库间的调拨需求申请
- **需求分析**：分析调拨的合理性和紧急性
- **调拨计划**：制定调拨计划和时间安排
- **调拨审批**：调拨申请的审批流程

#### 4.2 调拨单据管理
- **调拨单创建**：创建调拨单据和明细
- **单据审核**：调拨单据的审核确认
- **调拨执行**：出库、运输、入库全流程
- **单据归档**：调拨完成后的单据归档

#### 4.3 在途库存管理
- **在途状态跟踪**：调拨货物的在途状态
- **运输跟踪**：调拨货物的运输轨迹
- **异常处理**：运输过程中的异常情况处理
- **到货确认**：目标仓库的到货确认

#### 4.4 调拨成本管理
- **运输成本**：调拨过程中的运输费用
- **人工成本**：调拨作业的人工费用
- **损耗成本**：调拨过程中的货物损耗
- **成本分摊**：调拨成本在各仓库间的分摊

### 5. 库存预留管理 - 新增功能

#### 5.1 预留申请管理
- **预留申请**：销售订单、调拨单等业务的库存预留申请
- **预留审批**：预留申请的审批流程
- **预留确认**：预留申请的确认和执行
- **预留变更**：预留数量和日期的变更管理

#### 5.2 预留优先级管理
- **优先级设置**：设置预留的优先级（1-10级）
- **优先级规则**：VIP客户、紧急订单等高优先级
- **优先级调整**：根据业务需要调整预留优先级
- **优先级冲突处理**：高优先级预留抢占低优先级预留

#### 5.3 预留到期管理
- **到期预警**：预留即将到期的预警提醒
- **自动释放**：过期预留的自动释放
- **手动释放**：手动释放预留库存
- **释放记录**：预留释放的历史记录

#### 5.4 预留分析报表
- **预留统计**：各类型预留的数量统计
- **预留趋势**：预留数量的变化趋势
- **预留效率**：预留到出库的转化率分析
- **预留成本**：预留对库存周转的影响分析

## 数据模型设计

### 库存主表 (inventory)
```sql
- id: 主键
- product_id: 产品ID
- warehouse_id: 仓库ID
- location_code: 库位编码
- batch_number: 批次号
- quantity: 库存数量
- available_quantity: 可用数量
- reserved_quantity: 预留数量
- damaged_quantity: 损坏数量
- unit_cost: 单位成本
- production_date: 生产日期
- expiry_date: 到期日期
- status: 库存状态
- last_updated: 最后更新时间
```

### 库存流水表 (inventory_transactions)
```sql
- id: 主键
- transaction_code: 流水号
- product_id: 产品ID
- warehouse_id: 仓库ID
- batch_number: 批次号
- transaction_type: 交易类型(入库/出库/调拨/盘点/预留/释放)
- quantity: 数量
- unit_cost: 单位成本
- reference_type: 单据类型
- reference_id: 单据ID
- created_by: 操作人
- created_at: 操作时间
```

### 库存预留表 (inventory_reservations) - 新增
```sql
- id: 主键
- reservation_code: 预留单号
- inventory_id: 库存ID
- reference_type: 业务类型(销售订单/调拨单/手工预留)
- reference_id: 业务单据ID
- reference_code: 业务单据编号
- reserved_quantity: 预留数量
- reservation_date: 预留日期
- expiry_date: 预留到期日期
- status: 预留状态(active/expired/released)
- priority: 优先级(1-10)
- reserved_by: 预留人
- released_by: 释放人
- reserved_at: 预留时间
- released_at: 释放时间
- remarks: 备注
```

### 库存预警设置表 (inventory_alerts)
```sql
- id: 主键
- product_id: 产品ID
- warehouse_id: 仓库ID
- min_quantity: 最小库存量
- max_quantity: 最大库存量
- reorder_point: 补货点
- economic_order_quantity: 经济订货量
- lead_time_days: 采购周期(天)
- safety_stock: 安全库存
```

### 盘点记录表 (stock_counts)
```sql
- id: 主键
- count_code: 盘点单号
- warehouse_id: 仓库ID
- count_type: 盘点类型(全盘/抽盘/循环盘)
- count_date: 盘点日期
- count_by: 盘点人
- status: 盘点状态
- total_items: 盘点品项数
- difference_items: 差异品项数
- created_at: 创建时间
```

### 盘点明细表 (stock_count_details)
```sql
- id: 主键
- count_id: 盘点记录ID
- product_id: 产品ID
- batch_number: 批次号
- location_code: 库位编码
- system_quantity: 系统数量
- actual_quantity: 实盘数量
- difference_quantity: 差异数量
- difference_reason: 差异原因
- adjusted: 是否已调整
```

### 调拨单表 (transfer_orders)
```sql
- id: 主键
- transfer_code: 调拨单号
- from_warehouse_id: 调出仓库ID
- to_warehouse_id: 调入仓库ID
- transfer_date: 调拨日期
- reason: 调拨原因
- status: 状态
- total_quantity: 总数量
- created_by: 创建人
- approved_by: 审批人
- created_at: 创建时间
```

## 接口设计

### 库存查询接口
**统一接口**：`POST /api/inventory/stock`

**参数说明**：`action` - 操作类型，详见 InventoryStockAction 类型定义

#### Action字典说明
```typescript
export type InventoryStockAction = 
  // 基础CRUD操作
  | 'list'      // 查询库存列表
  | 'detail'    // 获取库存详情
  | 'update'    // 更新库存信息
  | 'delete'    // 删除库存记录
  
  // 库存查询
  | 'query'     // 按条件查询库存
  | 'by-product' // 按产品查询库存
  | 'by-warehouse' // 按仓库查询库存
  | 'by-batch'  // 按批次查询库存
  | 'by-location' // 按库位查询库存
  
  // 库存监控
  | 'alerts'    // 获取库存预警信息
  | 'expiring'  // 获取即将过期库存
  | 'low-stock' // 获取低库存产品
  | 'overstock' // 获取超储库存
  
  // 库存分析
  | 'statistics' // 库存统计分析
  | 'trends'     // 库存趋势分析
  | 'abc-analysis' // ABC分析
  | 'aging'      // 库存账龄分析
  
  // 库存移动
  | 'movement'  // 库存移动记录
  | 'history'   // 库存历史记录
  
  // 数据管理
  | 'export'    // 库存数据导出
  | 'import'    // 库存数据导入
  | 'sync'      // 库存数据同步;
```

#### 不同action的请求示例
```json
// 查询库存列表
{
  "action": "list",
  "params": {
    "page": 1,
    "size": 20,
    "warehouse_id": 123,
    "status": "active"
  }
}

// 按产品查询库存
{
  "action": "by-product",
  "params": {
    "product_id": 456,
    "include_reservations": true
  }
}

// 库存预警查询
{
  "action": "alerts",
  "params": {
    "alert_type": "low_stock",
    "warehouse_id": 123
  }
}

// 库存统计分析
{
  "action": "statistics",
  "params": {
    "warehouse_id": 123,
    "period": "2024-03",
    "analysis_type": "turnover"
  }
}
```

### 库存预留管理接口
**统一接口**：`POST /api/inventory/reservations`

**参数说明**：`action` - 操作类型，详见 InventoryReservationAction 类型定义

#### Action字典说明
```typescript
export type InventoryReservationAction = 
  // 基础CRUD操作
  | 'create'    // 创建库存预留
  | 'list'      // 查询预留列表
  | 'detail'    // 获取预留详情
  | 'update'    // 更新预留信息
  | 'delete'    // 删除预留记录
  
  // 预留流程
  | 'reserve'   // 预留库存
  | 'release'   // 释放预留
  | 'extend'    // 延长预留
  | 'cancel'    // 取消预留
  
  // 预留管理
  | 'priority'  // 优先级管理
  | 'conflicts' // 预留冲突检测
  | 'expired'   // 过期预留查询
  | 'auto-release' // 自动释放过期预留
  
  // 预留查询
  | 'by-reference' // 按业务单据查询预留
  | 'by-product'   // 按产品查询预留
  | 'by-warehouse' // 按仓库查询预留
  
  // 批量操作
  | 'batch-reserve' // 批量预留
  | 'batch-release' // 批量释放
  | 'batch-cancel'  // 批量取消
  
  // 统计分析
  | 'statistics' // 预留统计分析
  | 'trends'     // 预留趋势分析
  
  // 数据管理
  | 'export'     // 预留数据导出;
```

#### 不同action的请求示例
```json
// 创建库存预留
{
  "action": "create",
  "data": {
    "inventory_id": 123,
    "reference_type": "sales_order",
    "reference_id": 456,
    "reserved_quantity": 100,
    "expiry_date": "2024-04-15",
    "priority": 5
  }
}

// 预留冲突检测
{
  "action": "conflicts",
  "params": {
    "inventory_id": 123,
    "reserved_quantity": 200,
    "priority": 8
  }
}

// 批量预留
{
  "action": "batch-reserve",
  "data": {
    "reservations": [
      {
        "inventory_id": 123,
        "reserved_quantity": 50
      },
      {
        "inventory_id": 124,
        "reserved_quantity": 30
      }
    ],
    "reference_type": "transfer_order",
    "reference_id": 789
  }
}
```

### 批次管理接口
**统一接口**：`POST /api/inventory/batches`

**参数说明**：`action` - 操作类型，详见 BatchManagementAction 类型定义

#### Action字典说明
```typescript
export type BatchManagementAction = 
  // 基础CRUD操作
  | 'create'    // 创建批次记录
  | 'list'      // 查询批次列表
  | 'detail'    // 获取批次详情
  | 'update'    // 更新批次信息
  | 'delete'    // 删除批次记录
  
  // 批次查询
  | 'by-product' // 按产品查询批次
  | 'by-supplier' // 按供应商查询批次
  | 'by-date'   // 按日期查询批次
  | 'expiring'  // 即将过期批次查询
  
  // 批次操作
  | 'merge'     // 批次合并
  | 'split'     // 批次拆分
  | 'transfer'  // 批次转移
  | 'quality-check' // 批次质量检查
  
  // 批次追溯
  | 'trace'     // 批次追溯查询
  | 'upstream'  // 上游追溯
  | 'downstream' // 下游追溯
  | 'recall'    // 批次召回管理
  
  // 批次分析
  | 'statistics' // 批次统计分析
  | 'aging'      // 批次账龄分析
  | 'quality'    // 批次质量分析
  
  // 数据管理
  | 'export'     // 批次数据导出
  | 'import'     // 批次数据导入;
```

#### 不同action的请求示例
```json
// 创建批次记录
{
  "action": "create",
  "data": {
    "batch_number": "BT20240320001",
    "product_id": 123,
    "supplier_id": 456,
    "production_date": "2024-03-20",
    "expiry_date": "2027-03-20",
    "quantity": 1000
  }
}

// 批次追溯查询
{
  "action": "trace",
  "params": {
    "batch_number": "BT20240320001"
  }
}

// 批次合并
{
  "action": "merge",
  "data": {
    "source_batches": ["BT20240320001", "BT20240320002"],
    "target_batch": "BT20240320003",
    "reason": "同批次产品合并"
  }
}
```

### 库位管理接口
**统一接口**：`POST /api/inventory/locations`

**参数说明**：`action` - 操作类型，详见 LocationManagementAction 类型定义

#### Action字典说明
```typescript
export type LocationManagementAction = 
  // 基础CRUD操作
  | 'create'    // 创建库位
  | 'list'      // 查询库位列表
  | 'detail'    // 获取库位详情
  | 'update'    // 更新库位信息
  | 'delete'    // 删除库位
  
  // 库位操作
  | 'allocate'  // 自动分配库位
  | 'reserve'   // 库位预留
  | 'release'   // 释放库位
  | 'move'      // 库位移动
  
  // 库位查询
  | 'available' // 可用库位查询
  | 'occupied'  // 占用库位查询
  | 'by-zone'   // 按区域查询库位
  | 'by-type'   // 按类型查询库位
  
  // 库位优化
  | 'optimization' // 库位优化建议
  | 'heatmap'   // 库位热力图
  | 'usage-statistics' // 库位使用统计
  
  // 库位管理
  | 'clean'     // 库位清理
  | 'maintenance' // 库位维护
  | 'capacity'  // 库位容量管理
  
  // 数据管理
  | 'export'     // 库位数据导出
  | 'import'     // 库位数据导入;
```

#### 不同action的请求示例
```json
// 创建库位
{
  "action": "create",
  "data": {
    "location_code": "A-01-01-01",
    "warehouse_id": 123,
    "zone_id": 456,
    "location_type": "heavy_duty",
    "capacity": 1000,
    "dimensions": {
      "length": 2.0,
      "width": 1.5,
      "height": 2.5
    }
  }
}

// 自动分配库位
{
  "action": "allocate",
  "data": {
    "product_id": 123,
    "quantity": 500,
    "warehouse_id": 456,
    "preferred_zone": "A"
  }
}

// 库位优化建议
{
  "action": "optimization",
  "params": {
    "warehouse_id": 123,
    "optimization_type": "frequency_based"
  }
}
```

### 库存调拨接口
**统一接口**：`POST /api/inventory/transfers`

**参数说明**：`action` - 操作类型，详见 TransferManagementAction 类型定义

#### Action字典说明
```typescript
export type TransferManagementAction = 
  // 基础CRUD操作
  | 'create'    // 创建调拨单
  | 'list'      // 查询调拨单列表
  | 'detail'    // 获取调拨单详情
  | 'update'    // 更新调拨单
  | 'delete'    // 删除调拨单
  
  // 调拨流程
  | 'draft'     // 保存草稿
  | 'submit'    // 提交审批
  | 'approve'   // 审批通过
  | 'reject'    // 审批拒绝
  | 'execute'   // 执行调拨
  | 'cancel'    // 取消调拨
  
  // 调拨跟踪
  | 'tracking'  // 调拨跟踪查询
  | 'status'    // 调拨状态变更
  | 'in-transit' // 在途库存查询
  
  // 调拨管理
  | 'outbound'  // 调出作业
  | 'inbound'   // 调入作业
  | 'confirm'   // 到货确认
  
  // 统计分析
  | 'statistics' // 调拨统计分析
  | 'cost-analysis' // 调拨成本分析
  
  // 数据管理
  | 'export'     // 调拨数据导出;
```

#### 不同action的请求示例
```json
// 创建调拨单
{
  "action": "create",
  "data": {
    "from_warehouse_id": 123,
    "to_warehouse_id": 456,
    "transfer_date": "2024-03-25",
    "reason": "库存平衡",
    "items": [
      {
        "product_id": 789,
        "quantity": 200,
        "batch_number": "BT20240320001"
      }
    ]
  }
}

// 调拨跟踪查询
{
  "action": "tracking",
  "params": {
    "transfer_id": 123
  }
}

// 执行调拨
{
  "action": "execute",
  "data": {
    "transfer_id": 123,
    "executed_by": 456
  }
}
```

### 盘点管理接口
**统一接口**：`POST /api/inventory/stock-counts`

**参数说明**：`action` - 操作类型，详见 StockCountAction 类型定义

#### Action字典说明
```typescript
export type StockCountAction = 
  // 基础CRUD操作
  | 'create'    // 创建盘点单
  | 'list'      // 查询盘点单列表
  | 'detail'    // 获取盘点单详情
  | 'update'    // 更新盘点单
  | 'delete'    // 删除盘点单
  
  // 盘点流程
  | 'start'     // 开始盘点
  | 'pause'     // 暂停盘点
  | 'resume'    // 恢复盘点
  | 'complete'  // 完成盘点
  | 'cancel'    // 取消盘点
  
  // 盘点操作
  | 'count'     // 盘点录入
  | 'adjust'    // 盘点调整
  | 'approve'   // 盘点审批
  | 'reject'    // 盘点拒绝
  
  // 盘点查询
  | 'differences' // 盘点差异查询
  | 'progress'  // 盘点进度查询
  | 'by-counter' // 按盘点员查询
  
  // 统计分析
  | 'statistics' // 盘点统计分析
  | 'accuracy'   // 盘点准确率分析
  
  // 数据管理
  | 'export'     // 盘点数据导出;
```

#### 不同action的请求示例
```json
// 创建盘点单
{
  "action": "create",
  "data": {
    "warehouse_id": 123,
    "count_type": "cycle",
    "count_date": "2024-03-25",
    "count_by": 456,
    "items": [
      {
        "product_id": 789,
        "location_code": "A-01-01-01"
      }
    ]
  }
}

// 盘点录入
{
  "action": "count",
  "data": {
    "count_id": 123,
    "product_id": 789,
    "actual_quantity": 95,
    "remarks": "正常"
  }
}

// 盘点差异查询
{
  "action": "differences",
  "params": {
    "count_id": 123,
    "threshold": 5
  }
}
```

### 库存流水接口
**统一接口**：`POST /api/inventory/transactions`

**参数说明**：`action` - 操作类型，详见 InventoryTransactionAction 类型定义

#### Action字典说明
```typescript
export type InventoryTransactionAction = 
  // 基础CRUD操作
  | 'create'    // 创建库存流水
  | 'list'      // 查询流水列表
  | 'detail'    // 获取流水详情
  | 'update'    // 更新流水信息
  | 'delete'    // 删除流水记录
  
  // 流水查询
  | 'by-product' // 按产品查询流水
  | 'by-warehouse' // 按仓库查询流水
  | 'by-date'   // 按日期查询流水
  | 'by-type'   // 按类型查询流水
  | 'by-batch'  // 按批次查询流水
  
  // 流水分析
  | 'statistics' // 流水统计分析
  | 'trends'     // 流水趋势分析
  | 'summary'    // 流水汇总分析
  
  // 数据管理
  | 'export'     // 流水数据导出
  | 'import'     // 流水数据导入;
```

#### 不同action的请求示例
```json
// 创建库存流水
{
  "action": "create",
  "data": {
    "product_id": 123,
    "warehouse_id": 456,
    "batch_number": "BT20240320001",
    "transaction_type": "inbound",
    "quantity": 100,
    "unit_cost": 50,
    "reference_type": "purchase_order",
    "reference_id": 789
  }
}

// 按产品查询流水
{
  "action": "by-product",
  "params": {
    "product_id": 123,
    "start_date": "2024-03-01",
    "end_date": "2024-03-31",
    "transaction_type": "all"
  }
}

// 流水统计分析
{
  "action": "statistics",
  "params": {
    "warehouse_id": 123,
    "period": "2024-03",
    "analysis_type": "volume"
  }
}
```

## 业务规则

### 库存数据规则
1. 库存数量不能为负数
2. 可用数量 = 总数量 - 预留数量 - 损坏数量
3. 库存变动必须有对应的业务单据
4. 批次信息一旦录入不允许修改

### 库存预留规则 - 新增
1. 预留数量不能超过可用库存数量
2. 预留优先级高的可以抢占优先级低的预留
3. 预留到期后自动释放
4. 预留释放后库存重新变为可用状态
5. 预留期间库存状态为"预留"状态

### 批次管理规则
1. 每个批次必须有唯一的批次号
2. 出库必须遵循FIFO原则
3. 过期产品不允许出库销售
4. 批次合并需要特殊审批

### 库位管理规则
1. 每个库位只能存放一个产品的一个批次
2. 库位容量不能超过设计上限
3. 危险品必须存放在指定库位
4. 高价值产品存放在安全库位

### 盘点管理规则
1. 盘点期间禁止相关库存的出入库操作
2. 盘点差异超过阈值需要复盘
3. 盘点调整需要主管审批
4. 每月至少进行一次循环盘点

### 调拨管理规则
1. 调拨数量不能超过调出仓库库存
2. 调拨需要考虑运输能力和成本
3. 紧急调拨可以简化审批流程
4. 调拨完成后必须确认到货

## 关键业务流程

### 入库流程
```
收货验收 → 质量检验 → 分配库位 → 系统入库 → 库存更新 → 单据归档
```

### 出库流程
```
出库申请 → 库存检查 → 库存预留 → 分配批次 → 拣货作业 → 系统出库 → 库存更新 → 预留释放
```

### 库存预留流程 - 新增
```
预留申请 → 库存检查 → 预留确认 → 预留管理 → 出库执行 → 预留释放
```

### 盘点流程
```
盘点计划 → 冻结库存 → 盘点作业 → 差异分析 → 调整审批 → 库存调整
```

### 调拨流程
```
调拨申请 → 审批确认 → 调出作业 → 运输跟踪 → 调入确认 → 库存更新
```

## 权限控制

### 库存查询权限
- **查看权限**：所有业务人员
- **明细查询**：仓库、采购、销售
- **成本信息**：管理层、财务
- **分析报表**：管理层、业务主管

### 库存操作权限
- **入库权限**：仓库管理员
- **出库权限**：仓库管理员、销售
- **调整权限**：仓库主管
- **调拨权限**：仓库主管、运营主管
- **预留权限**：销售、仓库管理员 - 新增

### 批次管理权限
- **查看权限**：所有业务人员
- **修改权限**：仓库主管、质量主管
- **追溯权限**：质量部门、管理层

### 盘点管理权限
- **盘点执行**：仓库管理员
- **盘点审核**：仓库主管
- **差异调整**：仓库主管、系统管理员

### 预留管理权限 - 新增
- **预留申请**：销售、仓库管理员
- **预留审批**：仓库主管、销售主管
- **预留释放**：仓库管理员、系统自动
- **预留查询**：所有业务人员
