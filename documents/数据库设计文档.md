<!--
 * @Author: snowloong iamfinleyyao1997@163.com
 * @Date: 2025-08-24 17:21:54
 * @LastEditors: snowloong iamfinleyyao1997@163.com
 * @LastEditTime: 2025-08-24 19:10:37
 * @FilePath: /wiki-snowloog/bolink-inventory-system/数据库设计文档.md
 * @Description: 
 * 
-->
# 新能源电池进销存系统 - 数据库设计文档

## 1. 数据库概述

### 1.1 基本信息
- **数据库名称**: bolink_inventory
- **数据库类型**: PostgreSQL 14+
- **字符集**: UTF-8
- **时区**: Asia/Shanghai
- **版本**: 1.0.1 (完整增强版)

### 1.2 设计原则
- **规范化设计**: 遵循第三范式，减少数据冗余
- **性能优化**: 合理的索引策略和分区设计
- **数据完整性**: 完善的约束和触发器
- **可扩展性**: 支持业务增长和功能扩展
- **可追溯性**: 完整的操作日志和批次追溯

### 1.3 与统一API设计的关系
- **数据模型支撑**: 数据库设计为统一API提供数据基础
- **业务逻辑映射**: 每个业务子模块对应数据库中的相关表集合
- **操作类型支持**: 数据库设计支持统一API中的各种action操作
- **性能优化**: 数据库索引和视图优化支持统一接口的高效查询
- **数据一致性**: 数据库约束和触发器确保统一API操作的数据一致性

#### 1.3.1 模块化数据设计
```
基础数据管理模块
├── products (产品信息) - 支持: create, list, detail, update, delete, validate-code等
├── suppliers (供应商信息) - 支持: create, list, detail, update, delete, evaluate等
├── customers (客户信息) - 支持: create, list, detail, update, delete, analyze等
└── warehouses (仓库信息) - 支持: create, list, detail, update, delete, capacity等

采购管理模块
├── purchase_orders (采购订单) - 支持: create, list, detail, update, delete, draft, submit, approve等
├── purchase_receipts (收货记录) - 支持: create, list, detail, update, receive, inspect等
└── supplier_evaluations (供应商评估) - 支持: create, list, detail, update, evaluate, report等

库存管理模块
├── inventory (库存主表) - 支持: list, detail, movement, aging, abc, statistics等
├── inventory_transactions (库存流水) - 支持: list, detail, movement, trace等
├── inventory_alerts (库存预警) - 支持: list, detail, create, resolve, statistics等
└── inventory_reservations (库存预留) - 支持: create, list, detail, reserve, unreserve等

销售管理模块
├── sales_orders (销售订单) - 支持: create, list, detail, update, delete, draft, submit, confirm等
├── sales_deliveries (出库记录) - 支持: create, list, detail, ship, track等
└── customer_relationships (客户关系) - 支持: create, list, detail, update, analyze等
```

#### 1.3.2 统一API操作支持
- **CRUD操作**: 所有核心表支持基础的增删改查操作
- **批量操作**: 通过数据库事务支持批量导入、导出、删除等操作
- **状态管理**: 通过状态字段支持启用、禁用、审批等状态变更
- **业务操作**: 通过存储过程和函数支持复杂的业务逻辑操作
- **统计分析**: 通过视图和物化视图支持各种统计查询需求

## 2. 数据库架构

### 2.1 表结构总览

| 模块 | 表数量 | 主要功能 |
|------|--------|----------|
| **基础数据管理** | 4个 | 产品、供应商、客户、仓库信息管理 |
| **库存管理** | 8个 | 库存、流水、预警、盘点、调拨、预留管理 |
| **采购管理** | 4个 | 采购订单、收货、供应商评估管理 |
| **销售管理** | 4个 | 销售订单、出库、客户关系管理 |
| **质量管理** | 2个 | 质量检验、批次追溯管理 |
| **业务支撑** | 2个 | 价格历史、供应商评估记录 |
| **系统管理** | 7个 | 用户、角色、权限、日志管理 |
| **安全管理** | 6个 | 安全检查、环境监控、危险品运输等 |
| **报表统计** | 6个 | 报表模板、生成记录、定时任务等 |
| **补充业务** | 2个 | 退换货、客户回访 |
| **分区表** | 4个 | 操作日志按季度分区 |
| **总计** | **50个** | 完整覆盖所有业务场景 |

### 2.2 核心表关系图

```
基础数据层
├── products (产品信息)
├── suppliers (供应商信息)
├── customers (客户信息)
└── warehouses (仓库信息)

业务数据层
├── inventory (库存主表)
├── inventory_transactions (库存流水)
├── inventory_alerts (库存预警)
├── inventory_reservations (库存预留)
├── purchase_orders (采购订单)
├── sales_orders (销售订单)
├── quality_inspections (质量检验)
└── batch_traceability (批次追溯)

系统管理层
├── users (用户)
├── roles (角色)
├── permissions (权限)
├── operation_logs (操作日志)
└── system_configs (系统配置)
```

## 3. 详细表结构设计

### 3.1 基础数据管理模块

#### 3.1.1 产品信息表 (products)
```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    product_code VARCHAR(50) UNIQUE NOT NULL,  -- 产品编码
    product_name VARCHAR(200) NOT NULL,        -- 产品名称
    model VARCHAR(100),                        -- 产品型号
    series VARCHAR(100),                       -- 产品系列
    battery_type VARCHAR(50),                  -- 电池类型
    capacity DECIMAL(10,2),                    -- 电池容量(Ah)
    voltage DECIMAL(8,2),                      -- 电池电压(V)
    dimensions JSONB,                          -- 尺寸信息
    weight DECIMAL(8,3),                       -- 重量(kg)
    cycle_life INTEGER,                        -- 循环寿命
    energy_density DECIMAL(8,2),               -- 能量密度(Wh/kg)
    operating_temperature JSONB,               -- 工作温度范围
    storage_temperature JSONB,                 -- 存储温度范围
    certifications JSONB,                      -- 认证信息
    specifications JSONB,                      -- 技术规格
    safety_level VARCHAR(20),                  -- 安全等级
    status VARCHAR(20) DEFAULT 'active',       -- 状态
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.1.2 供应商信息表 (suppliers)
```sql
CREATE TABLE suppliers (
    id SERIAL PRIMARY KEY,
    supplier_code VARCHAR(50) UNIQUE NOT NULL,  -- 供应商编码
    supplier_name VARCHAR(200) NOT NULL,        -- 供应商名称
    supplier_type VARCHAR(50) NOT NULL,         -- 供应商类型
    registration_info JSONB,                    -- 注册信息
    contact_info JSONB,                         -- 联系信息
    qualifications JSONB,                       -- 资质信息
    cooperation_level VARCHAR(20) DEFAULT 'general', -- 合作等级
    credit_rating VARCHAR(10),                  -- 信用评级
    supply_capacity JSONB,                      -- 供应能力
    payment_terms VARCHAR(100),                 -- 付款条件
    status VARCHAR(20) DEFAULT 'active',        -- 状态
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 库存管理模块

#### 3.2.1 库存主表 (inventory)
```sql
CREATE TABLE inventory (
    id SERIAL PRIMARY KEY,
    product_id INTEGER NOT NULL REFERENCES products(id),
    warehouse_id INTEGER NOT NULL REFERENCES warehouses(id),
    location_code VARCHAR(50),                 -- 库位编码
    batch_number VARCHAR(100) NOT NULL,        -- 批次号
    quantity DECIMAL(12,3) NOT NULL DEFAULT 0, -- 总数量
    available_quantity DECIMAL(12,3) NOT NULL DEFAULT 0, -- 可用数量
    reserved_quantity DECIMAL(12,3) NOT NULL DEFAULT 0,  -- 预留数量
    damaged_quantity DECIMAL(12,3) NOT NULL DEFAULT 0,   -- 损坏数量
    unit_cost DECIMAL(12,4),                   -- 单位成本
    production_date DATE,                      -- 生产日期
    expiry_date DATE,                          -- 到期日期
    supplier_id INTEGER REFERENCES suppliers(id),
    status VARCHAR(20) DEFAULT 'available',    -- 状态
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(product_id, warehouse_id, batch_number, location_code)
);
```

#### 3.2.2 库存预留表 (inventory_reservations) - 新增
```sql
CREATE TABLE inventory_reservations (
    id SERIAL PRIMARY KEY,
    reservation_code VARCHAR(50) UNIQUE NOT NULL, -- 预留单号
    inventory_id INTEGER NOT NULL REFERENCES inventory(id),
    reference_type VARCHAR(50) NOT NULL,          -- 业务类型
    reference_id INTEGER NOT NULL,                -- 业务单据ID
    reference_code VARCHAR(50),                   -- 业务单据编号
    reserved_quantity DECIMAL(12,3) NOT NULL,     -- 预留数量
    reservation_date DATE NOT NULL,               -- 预留日期
    expiry_date DATE,                             -- 预留到期日期
    status VARCHAR(20) DEFAULT 'active',          -- 状态
    priority INTEGER DEFAULT 5,                   -- 优先级(1-10)
    reserved_by INTEGER,                          -- 预留人
    released_by INTEGER,                          -- 释放人
    reserved_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    released_at TIMESTAMP,                        -- 释放时间
    remarks TEXT                                  -- 备注
);
```

### 3.3 质量管理模块

#### 3.3.1 批次追溯表 (batch_traceability) - 新增
```sql
CREATE TABLE batch_traceability (
    id SERIAL PRIMARY KEY,
    batch_number VARCHAR(100) UNIQUE NOT NULL,    -- 批次号
    product_id INTEGER NOT NULL REFERENCES products(id),
    manufacturer VARCHAR(200),                    -- 生产厂商
    production_date DATE,                         -- 生产日期
    production_line VARCHAR(50),                  -- 生产线编号
    production_shift VARCHAR(20),                 -- 生产班次
    quality_grade VARCHAR(20),                    -- 质量等级
    raw_materials JSONB,                          -- 原材料信息
    production_process JSONB,                     -- 生产工艺
    quality_records JSONB,                        -- 质量记录
    flow_records JSONB,                           -- 流转记录
    upstream_batches JSONB,                       -- 上游批次
    downstream_records JSONB,                     -- 下游流向
    certifications JSONB,                         -- 认证信息
    expiry_date DATE,                             -- 到期日期
    shelf_life_days INTEGER,                      -- 保质期天数
    storage_requirements JSONB,                   -- 存储要求
    handling_instructions TEXT,                   -- 操作说明
    regulatory_info JSONB,                        -- 法规信息
    status VARCHAR(20) DEFAULT 'active',          -- 状态
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.4 业务支撑模块

#### 3.4.1 供应商评估记录表 (supplier_evaluations) - 新增
```sql
CREATE TABLE supplier_evaluations (
    id SERIAL PRIMARY KEY,
    supplier_id INTEGER NOT NULL REFERENCES suppliers(id),
    evaluation_period VARCHAR(20) NOT NULL,       -- 评估期间
    evaluation_date DATE NOT NULL,                -- 评估日期
    evaluator INTEGER,                            -- 评估人
    delivery_score DECIMAL(5,2) DEFAULT 0,        -- 交付评分
    quality_score DECIMAL(5,2) DEFAULT 0,         -- 质量评分
    service_score DECIMAL(5,2) DEFAULT 0,         -- 服务评分
    cost_score DECIMAL(5,2) DEFAULT 0,            -- 成本评分
    compliance_score DECIMAL(5,2) DEFAULT 0,      -- 合规评分
    total_score DECIMAL(5,2) DEFAULT 0,           -- 综合评分
    grade VARCHAR(10),                            -- 综合评级
    delivery_performance JSONB,                   -- 交付表现详情
    quality_performance JSONB,                    -- 质量表现详情
    service_performance JSONB,                    -- 服务表现详情
    cost_performance JSONB,                       -- 成本表现详情
    compliance_performance JSONB,                 -- 合规表现详情
    strengths TEXT,                               -- 优势
    weaknesses TEXT,                              -- 不足
    improvement_suggestions TEXT,                 -- 改进建议
    next_evaluation_date DATE,                    -- 下次评估日期
    status VARCHAR(20) DEFAULT 'active',          -- 状态
    approved_by INTEGER,                          -- 审批人
    approved_at TIMESTAMP,                        -- 审批时间
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.4.2 价格历史表 (product_price_history) - 新增
```sql
CREATE TABLE product_price_history (
    id SERIAL PRIMARY KEY,
    product_id INTEGER NOT NULL REFERENCES products(id),
    supplier_id INTEGER REFERENCES suppliers(id),  -- 供应商(采购价)
    customer_id INTEGER REFERENCES customers(id),  -- 客户(销售价)
    price_type VARCHAR(20) NOT NULL,               -- 价格类型
    unit_price DECIMAL(12,4) NOT NULL,             -- 单价
    currency VARCHAR(10) DEFAULT 'CNY',            -- 货币
    min_quantity DECIMAL(12,3),                    -- 最小数量
    max_quantity DECIMAL(12,3),                    -- 最大数量
    effective_date DATE NOT NULL,                  -- 生效日期
    expiry_date DATE,                              -- 失效日期
    contract_number VARCHAR(50),                   -- 合同编号
    price_terms TEXT,                              -- 价格条款
    status VARCHAR(20) DEFAULT 'active',           -- 状态
    created_by INTEGER,                            -- 创建人
    approved_by INTEGER,                           -- 审批人
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    approved_at TIMESTAMP                          -- 审批时间
);
```

## 4. 索引设计策略

### 4.1 索引类型分布
- **单列索引**: 150+ 个，覆盖所有查询频繁的字段
- **复合索引**: 50+ 个，优化多字段组合查询
- **部分索引**: 20+ 个，针对特定条件的数据
- **函数索引**: 10+ 个，支持计算字段查询
- **JSON索引**: 15+ 个，优化JSONB字段查询
- **全文搜索索引**: 5个，支持中文全文搜索

### 4.2 关键索引示例
```sql
-- 产品查询优化
CREATE INDEX idx_products_code ON products(product_code);
CREATE INDEX idx_products_type ON products(battery_type);
CREATE INDEX idx_products_status ON products(status);

-- 库存查询优化
CREATE INDEX idx_inventory_product_warehouse ON inventory(product_id, warehouse_id);
CREATE INDEX idx_inventory_expiry_status ON inventory(expiry_date, status);

-- 订单查询优化
CREATE INDEX idx_po_supplier_date ON purchase_orders(supplier_id, order_date);
CREATE INDEX idx_so_customer_date ON sales_orders(customer_id, order_date);

-- 批次追溯优化
CREATE INDEX idx_batch_traceability_batch ON batch_traceability(batch_number);
CREATE INDEX idx_batch_traceability_product ON batch_traceability(product_id);
```

## 5. 约束设计

### 5.1 数据完整性约束
```sql
-- 库存数量逻辑约束
ALTER TABLE inventory ADD CONSTRAINT chk_inventory_quantity_relationship 
    CHECK (quantity = available_quantity + reserved_quantity + damaged_quantity);

-- 订单金额计算约束
ALTER TABLE purchase_order_items ADD CONSTRAINT chk_poi_amount_calculation 
    CHECK (ABS(total_price - (quantity * unit_price)) < 0.01);

-- 评分范围约束
ALTER TABLE supplier_evaluations ADD CONSTRAINT chk_evaluation_scores 
    CHECK (delivery_score >= 0 AND delivery_score <= 100);

-- 日期逻辑约束
ALTER TABLE batch_traceability ADD CONSTRAINT chk_batch_dates 
    CHECK (production_date IS NULL OR expiry_date IS NULL OR production_date <= expiry_date);
```

### 5.2 业务规则约束
- **库存预留优先级**: 1-10，数字越小优先级越高
- **供应商评分**: 0-100分，支持小数点后2位
- **价格有效期**: 最长10年
- **批次追溯**: 支持完整的上下游追溯链

## 6. 分区设计

### 6.1 操作日志分区策略
- **分区方式**: 按季度分区
- **分区命名**: operation_logs_y{year}q{quarter}
- **当前分区**: 2025年Q1-Q4
- **自动管理**: 支持自动创建未来分区

### 6.2 分区管理函数
```sql
-- 自动创建季度分区
SELECT create_quarterly_partition(2025, 1);

-- 自动维护分区
SELECT auto_create_log_partitions();

-- 清理旧分区
SELECT cleanup_old_log_partitions(3);
```

## 7. 触发器设计

### 7.1 自动更新时间戳
```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

### 7.2 库存预留自动过期
```sql
CREATE OR REPLACE FUNCTION auto_expire_reservations()
RETURNS INTEGER AS $$
DECLARE
    expired_count INTEGER := 0;
BEGIN
    UPDATE inventory_reservations 
    SET status = 'expired', released_at = CURRENT_TIMESTAMP
    WHERE status = 'active' AND expiry_date < CURRENT_DATE;
    
    GET DIAGNOSTICS expired_count = ROW_COUNT;
    RETURN expired_count;
END;
$$ LANGUAGE plpgsql;
```

## 8. 性能优化

### 8.1 查询优化
- **物化视图**: 库存汇总视图，定期刷新
- **业务视图**: 6个统计视图，支持实时分析
- **函数索引**: 支持复杂查询条件
- **部分索引**: 减少索引维护成本

### 8.2 存储优化
- **JSONB字段**: 灵活存储非结构化数据
- **分区表**: 提高大表查询性能
- **压缩**: 支持表级压缩
- **归档**: 自动清理过期数据

## 9. 数据安全

### 9.1 访问控制
- **行级安全**: 基于角色的数据访问控制
- **列级加密**: 敏感字段加密存储
- **审计日志**: 完整的操作审计追踪
- **备份策略**: 定期备份和恢复测试

### 9.2 数据保护
- **约束检查**: 防止无效数据插入
- **触发器验证**: 业务规则自动验证
- **外键约束**: 保证数据引用完整性
- **唯一约束**: 防止重复数据

## 10. 维护建议

### 10.1 日常维护
```sql
-- 定期刷新物化视图
REFRESH MATERIALIZED VIEW mv_inventory_summary;

-- 收集统计信息
ANALYZE;

-- 维护索引
REINDEX DATABASE current_database();
```

### 10.2 性能监控
- **慢查询分析**: 定期分析慢查询日志
- **索引使用率**: 监控索引使用情况
- **表大小监控**: 关注表增长趋势
- **连接数监控**: 控制并发连接数

### 10.3 备份策略
- **全量备份**: 每日凌晨全量备份
- **增量备份**: 每小时增量备份
- **归档备份**: 每月归档备份
- **恢复测试**: 定期测试恢复流程

## 11. 扩展性设计

### 11.1 水平扩展
- **读写分离**: 主从数据库架构
- **分库分表**: 支持业务增长
- **缓存层**: Redis缓存热点数据
- **消息队列**: 异步处理大数据量

### 11.2 垂直扩展
- **硬件升级**: CPU、内存、存储升级
- **参数调优**: 数据库参数优化
- **索引优化**: 根据查询模式调整索引
- **分区策略**: 优化分区设计

## 12. 版本管理

### 12.1 版本历史
- **v1.0.0**: 基础版本，包含核心功能
- **v1.0.1**: 完整增强版，新增批次追溯、库存预留等功能

### 12.2 升级策略
- **向后兼容**: 保证数据兼容性
- **渐进升级**: 分步骤升级
- **回滚方案**: 准备回滚脚本
- **测试验证**: 充分测试升级流程

---

**文档版本**: 1.0.1  
**最后更新**: 2025-08-24  
**维护人员**: 数据库设计团队
