# @bolink-inventory-system/reports - 报表统计模块

## 模块概述
报表统计模块负责将业务数据转化为有价值的分析报表，为管理层决策提供数据支撑，涵盖进销存、库存分析、供应商绩效、客户分析等各个维度。

## 核心功能

### 1. 进销存报表

#### 1.1 库存明细报表
- **实时库存明细**：当前所有产品的库存详细信息
- **按仓库分组**：各仓库的库存分布情况
- **按产品分组**：各产品的库存分布情况
- **按批次分组**：各批次的库存状态
- **库存价值统计**：库存的总价值和分类价值
- **库存预留统计**：各产品的预留库存情况

#### 1.2 进销存汇总报表
- **期间进销存汇总**：指定期间的进销存数量统计
- **按产品汇总**：各产品的进销存情况
- **按供应商汇总**：各供应商的采购情况
- **按客户汇总**：各客户的销售情况
- **按仓库汇总**：各仓库的进出库情况

#### 1.3 库存变动分析
- **库存流水明细**：详细的库存变动流水
- **变动原因分析**：采购入库、销售出库、调拨、预留等原因分析
- **库存趋势分析**：库存数量的变化趋势
- **异常变动分析**：识别异常的库存变动
- **库存预测**：基于历史数据的库存预测

#### 1.4 库存对账报表
- **期初期末对账**：期初库存、期间变动、期末库存对账
- **财务库存对账**：实物库存与财务账面库存对账
- **系统数据对账**：系统数据与实际盘点数据对账
- **差异分析报告**：库存差异的详细分析
- **调整建议**：库存差异的调整建议

### 2. 库存分析

#### 2.1 ABC分析
- **按价值ABC分析**：根据库存价值进行ABC分类
- **按数量ABC分析**：根据库存数量进行ABC分类
- **按流动性ABC分析**：根据周转速度进行ABC分类
- **动态ABC分析**：定期更新的ABC分析结果
- **ABC策略建议**：针对不同类别的管理策略建议

#### 2.2 库存结构分析
- **产品结构分析**：不同产品类型的库存占比
- **品牌结构分析**：不同品牌的库存分布
- **供应商结构分析**：不同供应商产品的库存占比
- **价值结构分析**：不同价值区间的库存分布
- **仓库结构分析**：各仓库的库存结构对比

#### 2.3 呆滞库存分析
- **呆滞库存识别**：识别长期无流动的库存
- **呆滞原因分析**：分析库存呆滞的主要原因
- **呆滞时间分析**：按呆滞时间长短分类分析
- **呆滞价值统计**：呆滞库存的价值统计
- **处置建议**：呆滞库存的处置建议

#### 2.4 库存周转率分析
- **整体周转率**：全部库存的周转率统计
- **产品周转率**：各产品的周转率对比
- **供应商周转率**：各供应商产品的周转率
- **仓库周转率**：各仓库的库存周转情况
- **周转率趋势**：库存周转率的变化趋势

### 3. 供应商绩效

#### 3.1 供应商交期分析
- **按时交货率**：供应商按时交货的统计
- **平均交期**：供应商平均交货周期
- **延期分析**：延期交货的原因和影响分析
- **提前交货分析**：提前交货的情况统计
- **交期趋势分析**：供应商交期表现的趋势

#### 3.2 质量绩效统计
- **质量合格率**：供应商产品质量合格率
- **质量问题统计**：各类质量问题的统计
- **退货率统计**：因质量问题的退货率
- **客户投诉统计**：因供应商质量问题的客户投诉
- **质量改进跟踪**：供应商质量改进效果跟踪

#### 3.3 采购成本分析
- **价格趋势分析**：供应商价格的变化趋势
- **成本结构分析**：采购成本的构成分析
- **价格对比分析**：不同供应商的价格对比
- **成本节约分析**：通过优化实现的成本节约
- **总成本分析**：包含隐性成本的总成本分析

#### 3.4 供应商综合评价
- **综合绩效评分**：供应商的综合绩效评分
- **绩效排名**：供应商绩效排名对比
- **绩效趋势**：供应商绩效的变化趋势
- **改进建议**：针对供应商的改进建议
- **合作建议**：未来合作策略建议

### 4. 客户分析

#### 4.1 客户销售排行
- **销售额排行**：客户按销售额排名
- **销售量排行**：客户按销售数量排名
- **订单频次排行**：客户按订单频次排名
- **利润贡献排行**：客户按利润贡献排名
- **成长性排行**：客户按销售增长率排名

#### 4.2 客户贡献度分析
- **销售贡献分析**：客户对总销售额的贡献
- **利润贡献分析**：客户对总利润的贡献
- **80/20分析**：识别核心客户群体
- **客户价值分析**：客户的综合价值评估
- **客户生命周期价值**：客户长期价值评估

#### 4.3 客户需求趋势分析
- **产品需求趋势**：客户对不同产品的需求趋势
- **季节性需求分析**：客户需求的季节性变化
- **区域需求分析**：不同区域的需求特点
- **行业需求分析**：不同行业客户的需求特点
- **新兴需求识别**：识别新兴的客户需求

#### 4.4 客户流失分析
- **流失客户识别**：识别已流失的客户
- **流失原因分析**：分析客户流失的主要原因
- **流失风险预警**：预警有流失风险的客户
- **挽回策略建议**：客户挽回的策略建议
- **防流失措施**：预防客户流失的措施

## 数据模型设计

### 报表模板表 (report_templates)
```sql
- id: 主键
- template_code: 模板编码
- template_name: 模板名称
- template_type: 模板类型
- category: 报表分类
- data_source: 数据源
- query_sql: 查询SQL
- parameters: 参数定义(JSON)
- layout_config: 布局配置(JSON)
- chart_config: 图表配置(JSON)
- created_by: 创建人
- created_at: 创建时间
```

### 报表任务表 (report_tasks)
```sql
- id: 主键
- task_code: 任务编号
- template_id: 模板ID
- task_name: 任务名称
- parameters: 参数值(JSON)
- schedule_type: 调度类型
- schedule_config: 调度配置(JSON)
- status: 状态
- last_run_time: 最后运行时间
- next_run_time: 下次运行时间
- created_by: 创建人
- created_at: 创建时间
```

### 报表生成记录表 (report_generations)
```sql
- id: 主键
- generation_code: 生成编号
- template_id: 模板ID
- task_id: 任务ID
- parameters: 参数值(JSON)
- start_time: 开始时间
- end_time: 结束时间
- status: 状态
- file_path: 文件路径
- file_size: 文件大小
- error_message: 错误信息
- generated_by: 生成人
- created_at: 创建时间
```

### 分析指标表 (analysis_metrics)
```sql
- id: 主键
- metric_code: 指标编码
- metric_name: 指标名称
- metric_type: 指标类型
- calculation_formula: 计算公式
- data_source: 数据源
- update_frequency: 更新频率
- target_value: 目标值
- threshold_config: 阈值配置(JSON)
- created_by: 创建人
- created_at: 创建时间
```

### 指标数据表 (metric_data)
```sql
- id: 主键
- metric_id: 指标ID
- dimension_values: 维度值(JSON)
- metric_value: 指标值
- calculation_date: 计算日期
- data_period: 数据期间
- status: 状态
- created_at: 创建时间
```

### 仪表板配置表 (dashboard_configs)
```sql
- id: 主键
- dashboard_code: 仪表板编码
- dashboard_name: 仪表板名称
- layout_config: 布局配置(JSON)
- widget_configs: 组件配置(JSON)
- access_roles: 访问角色(JSON)
- refresh_interval: 刷新间隔
- created_by: 创建人
- created_at: 创建时间
```

## 接口设计

### 报表模板管理接口
**统一接口**：`POST /api/reports/templates`

**参数说明**：`action` - 操作类型，详见 ReportTemplateAction 类型定义

#### Action字典说明
```typescript
export type ReportTemplateAction = 
  // 基础CRUD操作
  | 'create'    // 创建报表模板
  | 'list'      // 查询模板列表
  | 'detail'    // 获取模板详情
  | 'update'    // 更新模板信息
  | 'delete'    // 删除模板
  
  // 模板操作
  | 'validate'  // 验证模板配置
  | 'clone'     // 克隆模板
  | 'publish'   // 发布模板
  | 'unpublish' // 取消发布
  | 'archive'   // 归档模板
  
  // 模板查询
  | 'categories' // 获取模板分类
  | 'by-category' // 按分类查询模板
  | 'by-type'   // 按类型查询模板
  | 'by-creator' // 按创建者查询模板
  
  // 统计分析
  | 'statistics' // 模板使用统计
  | 'usage-analysis' // 使用情况分析
  
  // 数据管理
  | 'export'     // 模板数据导出
  | 'import'     // 模板数据导入;
```

#### 不同action的请求示例
```json
// 创建报表模板
{
  "action": "create",
  "data": {
    "template_code": "INV001",
    "template_name": "库存明细报表",
    "template_type": "inventory",
    "category": "inventory_analysis",
    "data_source": "inventory_data",
    "query_sql": "SELECT * FROM inventory WHERE warehouse_id = :warehouse_id",
    "parameters": {
      "warehouse_id": {"type": "integer", "required": true}
    }
  }
}

// 验证模板配置
{
  "action": "validate",
  "data": {
    "template_id": 123,
    "test_parameters": {
      "warehouse_id": 456
    }
  }
}

// 克隆模板
{
  "action": "clone",
  "data": {
    "template_id": 123,
    "new_template_name": "库存明细报表-副本",
    "new_template_code": "INV001_COPY"
  }
}

// 模板使用统计
{
  "action": "statistics",
  "params": {
    "period": "2024-Q1",
    "template_id": 123
  }
}
```

### 报表生成接口
**统一接口**：`POST /api/reports/generations`

**参数说明**：`action` - 操作类型，详见 ReportGenerationAction 类型定义

#### Action字典说明
```typescript
export type ReportGenerationAction = 
  // 基础CRUD操作
  | 'create'    // 创建报表生成任务
  | 'list'      // 查询生成记录列表
  | 'detail'    // 获取生成记录详情
  | 'update'    // 更新生成记录
  | 'delete'    // 删除生成记录
  
  // 生成流程
  | 'generate'  // 生成报表
  | 'async-generate' // 异步生成报表
  | 'status'    // 查询生成状态
  | 'progress'  // 查询生成进度
  | 'cancel'    // 取消生成任务
  | 'retry'     // 重试生成任务
  
  // 文件管理
  | 'download'  // 下载生成的报表
  | 'preview'   // 预览报表
  | 'share'     // 分享报表
  | 'archive'   // 归档报表
  
  // 批量操作
  | 'batch-generate' // 批量生成报表
  | 'batch-download' // 批量下载报表
  
  // 统计分析
  | 'statistics' // 生成记录统计
  | 'performance' // 生成性能分析
  
  // 数据管理
  | 'export'     // 生成记录导出;
```

#### 不同action的请求示例
```json
// 创建报表生成任务
{
  "action": "create",
  "data": {
    "template_id": 123,
    "task_name": "库存月报生成",
    "parameters": {
      "warehouse_id": 456,
      "report_date": "2024-03"
    },
    "output_format": "pdf"
  }
}

// 异步生成报表
{
  "action": "async-generate",
  "data": {
    "template_id": 123,
    "parameters": {
      "warehouse_id": 456,
      "report_date": "2024-03"
    },
    "callback_url": "https://api.example.com/callback"
  }
}

// 查询生成状态
{
  "action": "status",
  "params": {
    "generation_id": 789
  }
}

// 下载生成的报表
{
  "action": "download",
  "params": {
    "generation_id": 789,
    "format": "pdf"
  }
}

// 批量生成报表
{
  "action": "batch-generate",
  "data": {
    "template_id": 123,
    "batch_parameters": [
      {"warehouse_id": 456, "report_date": "2024-03"},
      {"warehouse_id": 789, "report_date": "2024-03"}
    ]
  }
}
```

### 数据查询接口
**统一接口**：`POST /api/reports/data`

**参数说明**：`action` - 操作类型，详见 DataQueryAction 类型定义

#### Action字典说明
```typescript
export type DataQueryAction = 
  // 数据查询
  | 'inventory' // 获取库存数据
  | 'sales'     // 获取销售数据
  | 'procurement' // 获取采购数据
  | 'quality'   // 获取质量数据
  | 'safety'    // 获取安全数据
  | 'custom'    // 自定义数据查询
  
  // 缓存管理
  | 'cache-status' // 查询缓存状态
  | 'cache-refresh' // 刷新数据缓存
  | 'cache-clear' // 清除数据缓存
  | 'cache-warm' // 预热数据缓存
  
  // 性能监控
  | 'performance' // 查询性能统计
  | 'slow-queries' // 慢查询分析
  | 'query-optimization' // 查询优化建议
  
  // 数据管理
  | 'export'     // 数据导出
  | 'backup'     // 数据备份;
```

#### 不同action的请求示例
```json
// 获取库存数据
{
  "action": "inventory",
  "params": {
    "warehouse_id": 123,
    "product_id": 456,
    "date_range": {
      "start_date": "2024-03-01",
      "end_date": "2024-03-31"
    }
  }
}

// 自定义数据查询
{
  "action": "custom",
  "data": {
    "sql": "SELECT * FROM inventory WHERE warehouse_id = :warehouse_id",
    "parameters": {
      "warehouse_id": 123
    },
    "limit": 1000
  }
}

// 刷新数据缓存
{
  "action": "cache-refresh",
  "data": {
    "cache_keys": ["inventory_data", "sales_data"],
    "force_refresh": true
  }
}

// 查询性能统计
{
  "action": "performance",
  "params": {
    "period": "2024-03",
    "query_type": "inventory"
  }
}
```

### 仪表板管理接口
**统一接口**：`POST /api/reports/dashboards`

**参数说明**：`action` - 操作类型，详见 DashboardAction 类型定义

#### Action字典说明
```typescript
export type DashboardAction = 
  // 基础CRUD操作
  | 'create'    // 创建仪表板
  | 'list'      // 查询仪表板列表
  | 'detail'    // 获取仪表板详情
  | 'update'    // 更新仪表板
  | 'delete'    // 删除仪表板
  
  // 仪表板操作
  | 'clone'     // 克隆仪表板
  | 'publish'   // 发布仪表板
  | 'unpublish' // 取消发布
  | 'share'     // 分享仪表板
  | 'archive'   // 归档仪表板
  
  // 组件管理
  | 'widgets'   // 获取组件列表
  | 'add-widget' // 添加组件
  | 'update-widget' // 更新组件
  | 'delete-widget' // 删除组件
  | 'widget-config' // 组件配置
  
  // 布局管理
  | 'layout'    // 更新布局
  | 'layout-save' // 保存布局
  | 'layout-reset' // 重置布局
  
  // 数据刷新
  | 'refresh'   // 实时数据刷新
  | 'auto-refresh' // 自动刷新配置
  
  // 统计分析
  | 'statistics' // 仪表板使用统计
  | 'usage-analysis' // 使用情况分析
  
  // 数据管理
  | 'export'     // 仪表板配置导出
  | 'import'     // 仪表板配置导入;
```

#### 不同action的请求示例
```json
// 创建仪表板
{
  "action": "create",
  "data": {
    "dashboard_code": "DASH001",
    "dashboard_name": "库存管理仪表板",
    "layout_config": {
      "columns": 3,
      "rows": 4
    },
    "access_roles": ["inventory_manager", "warehouse_manager"]
  }
}

// 添加组件
{
  "action": "add-widget",
  "data": {
    "dashboard_id": 123,
    "widget_type": "chart",
    "widget_config": {
      "title": "库存趋势",
      "chart_type": "line",
      "data_source": "inventory_trends"
    },
    "position": {
      "x": 0,
      "y": 0,
      "width": 2,
      "height": 2
    }
  }
}

// 更新布局
{
  "action": "layout",
  "data": {
    "dashboard_id": 123,
    "layout": [
      {
        "widget_id": 456,
        "position": {"x": 0, "y": 0, "width": 2, "height": 2}
      }
    ]
  }
}

// 实时数据刷新
{
  "action": "refresh",
  "params": {
    "dashboard_id": 123,
    "widget_ids": [456, 789]
  }
}
```

### 定时任务接口
**统一接口**：`POST /api/reports/scheduled-tasks`

**参数说明**：`action` - 操作类型，详见 ScheduledTaskAction 类型定义

#### Action字典说明
```typescript
export type ScheduledTaskAction = 
  // 基础CRUD操作
  | 'create'    // 创建定时任务
  | 'list'      // 查询任务列表
  | 'detail'    // 获取任务详情
  | 'update'    // 更新任务配置
  | 'delete'    // 删除定时任务
  
  // 任务控制
  | 'start'     // 启动任务
  | 'stop'      // 停止任务
  | 'pause'     // 暂停任务
  | 'resume'    // 恢复任务
  | 'execute-now' // 立即执行
  
  // 任务监控
  | 'status'    // 查询任务状态
  | 'execution-history' // 执行历史
  | 'logs'      // 任务日志
  | 'performance' // 任务性能
  
  // 调度管理
  | 'schedule'  // 调度配置
  | 'schedule-validate' // 调度验证
  | 'schedule-test' // 调度测试
  
  // 统计分析
  | 'statistics' // 任务执行统计
  | 'success-rate' // 成功率分析
  
  // 数据管理
  | 'export'     // 任务配置导出
  | 'import'     // 任务配置导入;
```

#### 不同action的请求示例
```json
// 创建定时任务
{
  "action": "create",
  "data": {
    "task_code": "TASK001",
    "task_name": "库存日报生成",
    "template_id": 123,
    "schedule_type": "daily",
    "schedule_config": {
      "time": "08:00",
      "timezone": "Asia/Shanghai"
    },
    "parameters": {
      "warehouse_id": 456
    }
  }
}

// 启动任务
{
  "action": "start",
  "data": {
    "task_id": 789
  }
}

// 立即执行
{
  "action": "execute-now",
  "data": {
    "task_id": 789,
    "parameters": {
      "warehouse_id": 456,
      "report_date": "2024-03-25"
    }
  }
}

// 查询执行历史
{
  "action": "execution-history",
  "params": {
    "task_id": 789,
    "start_date": "2024-03-01",
    "end_date": "2024-03-31"
  }
}
```

### 分析指标接口
**统一接口**：`POST /api/reports/metrics`

**参数说明**：`action` - 操作类型，详见 AnalysisMetricAction 类型定义

#### Action字典说明
```typescript
export type AnalysisMetricAction = 
  // 基础CRUD操作
  | 'create'    // 创建分析指标
  | 'list'      // 查询指标列表
  | 'detail'    // 获取指标详情
  | 'update'    // 更新指标配置
  | 'delete'    // 删除指标
  
  // 指标操作
  | 'validate'  // 验证指标公式
  | 'calculate' // 计算指标值
  | 'values'    // 获取指标值
  | 'trends'    // 指标趋势分析
  
  // 指标管理
  | 'enable'    // 启用指标
  | 'disable'   // 禁用指标
  | 'archive'   // 归档指标
  | 'clone'     // 克隆指标
  
  // 阈值管理
  | 'threshold' // 阈值配置
  | 'alert'     // 告警配置
  | 'notification' // 通知配置
  
  // 统计分析
  | 'statistics' // 指标使用统计
  | 'performance' // 指标性能分析
  
  // 数据管理
  | 'export'     // 指标配置导出
  | 'import'     // 指标配置导入;
```

#### 不同action的请求示例
```json
// 创建分析指标
{
  "action": "create",
  "data": {
    "metric_code": "INV_TURNOVER",
    "metric_name": "库存周转率",
    "metric_type": "ratio",
    "calculation_formula": "sales_quantity / average_inventory",
    "data_source": "inventory_sales_data",
    "update_frequency": "daily"
  }
}

// 计算指标值
{
  "action": "calculate",
  "data": {
    "metric_id": 123,
    "calculation_date": "2024-03-25",
    "parameters": {
      "warehouse_id": 456
    }
  }
}

// 获取指标值
{
  "action": "values",
  "params": {
    "metric_id": 123,
    "start_date": "2024-03-01",
    "end_date": "2024-03-31",
    "dimensions": ["warehouse_id", "product_id"]
  }
}

// 指标趋势分析
{
  "action": "trends",
  "params": {
    "metric_id": 123,
    "period": "12months",
    "trend_type": "moving_average"
  }
}
```

## 业务规则

### 报表生成规则
1. 大型报表采用异步生成方式
2. 报表文件保存30天后自动删除
3. 敏感报表需要权限验证
4. 报表参数必须经过验证

### 数据更新规则
1. 库存数据实时更新
2. 统计数据每小时更新一次
3. 分析指标每日计算一次
4. 历史数据按月归档

### 访问控制规则
1. 报表访问需要相应权限
2. 敏感数据需要脱敏处理
3. 导出功能需要特殊权限
4. 操作日志完整记录

### 性能优化规则
1. 大数据量查询使用分页
2. 复杂统计使用预计算
3. 历史数据使用汇总表
4. 缓存常用报表结果

## 关键业务流程

### 报表生成流程
```
参数输入 → 权限验证 → 数据查询 → 数据处理 → 报表生成 → 文件存储 → 结果返回
```

### 定时报表流程
```
任务调度 → 参数准备 → 数据提取 → 报表生成 → 结果通知 → 文件归档
```

### 指标计算流程
```
数据采集 → 数据清洗 → 指标计算 → 结果存储 → 异常检测 → 结果发布
```

### 仪表板刷新流程
```
刷新触发 → 数据获取 → 指标计算 → 图表渲染 → 页面更新 → 缓存更新
```

## 权限控制

### 报表查看权限
- **基础报表**：所有业务人员
- **管理报表**：主管及以上级别
- **财务报表**：财务人员、管理层
- **敏感报表**：特定角色授权

### 报表操作权限
- **生成权限**：具有查看权限的用户
- **导出权限**：需要特殊授权
- **打印权限**：需要特殊授权
- **分享权限**：需要特殊授权

### 报表管理权限
- **模板创建**：系统管理员、报表管理员
- **模板修改**：模板创建者、系统管理员
- **任务管理**：系统管理员、报表管理员
- **系统配置**：系统管理员

### 数据访问权限
- **实时数据**：业务相关人员
- **历史数据**：分析人员、管理层
- **汇总数据**：管理层、决策层
- **明细数据**：业务操作人员
